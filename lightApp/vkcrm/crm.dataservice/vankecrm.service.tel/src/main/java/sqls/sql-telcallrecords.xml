<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>话务信息查询</comment>

	<!-- 多条件查询话务信息 -->
    <entry key="service.telcallrecords">
        <![CDATA[
				SELECT	tcr.id AS id,
						tcr.code AS code,
						tcr.callId AS callId,
						tcr.recordId AS recordId,
						tcr.callTime AS callTime,
						tcr.beginTime AS beginTime,
						tcr.endTime AS endTime,
						tcr.duration AS duration,
						tcr.isConnect AS isConnect,
						tcr.telephonist AS telephonist,
						tcr.telephonistId AS telephonistId,
						tcr.hasCheck AS hasCheck,
						tcr.checker AS checker,
						tcr.checkerId AS checkerId,
						tcr.callNumber AS callNumber,
						tcr.type AS type,
						tcr.typeText AS typeText

				FROM	tel_call_records AS tcr

				WHERE		1 = 1
				{?AND		tcr.id = #id#}
				{?AND		tcr.code = #code#}
				{?AND		tcr.callId = #callId#}
				{?AND		tcr.recordId = #recordId#}
				{?AND		tcr.callTime = #callTime#}
				{?AND		tcr.callNumber = #callNumber#}
				{?AND		tcr.beginTime = #beginTime#}
				{?AND		tcr.endTime = #endTime#}
				{?AND		tcr.duration = #duration#}
				{?AND		tcr.isConnect = #isConnect#}
				{?AND		tcr.telephonist = #telephonist#}
				{?AND		tcr.telephonistId = #telephonistId#}
				{?AND		tcr.hasCheck = #hasCheck#}
				{?AND		tcr.checker = #checker#}
				{?AND		tcr.checkerId = #checkerId#}
				{?AND		tcr.type = #type#}
				ORDER BY tcr.callTime DESC

        ]]>
    </entry>
	<!--modified by liaochao 20160201-->
	<!-- 查询通话记录（话务查询） -->
    <entry key="service.tel.call.records">
        <![CDATA[
			SELECT		tcr.id,
						tcr.callId AS callId,
						tcr.recordId AS tapeCode,
						tcr.callTime AS callTime,
						tcr.type AS type,
						tcr.typeText AS typeText,
						tcr.callNumber AS callNumber,
						tcr.duration AS duration,
						tcr.hangup_byself AS hangUp,
						tcr.beginTime as beginTime,
						(SELECT GROUP_CONCAT(mtcr.reasonId SEPARATOR ';') FROM mid_tel_callreason AS mtcr WHERE mtcr.callRecordId = tcr.id AND IFNULL(mtcr.isDeleted, 0) = 0) AS reasonCodes,
						sec_to_time(tcr.duration) AS durationTime,
						tcr.telephonist AS telephonist,
			CASE 		tcr.hasCheck
			WHEN 		1 THEN '是'
			WHEN 		0 THEN '否'
			END 		AS hasCheck,
						(SELECT GROUP_CONCAT(tc.content SEPARATOR ';') FROM tel_callreason AS tc WHERE tc.id IN (SELECT mtcr.reasonId AS reasonId FROM mid_tel_callreason AS mtcr WHERE mtcr.callRecordId = tcr.id AND IFNULL(mtcr.isDeleted, 0) = 0) )AS reasons,
						(SELECT GROUP_CONCAT(tr.taskNo SEPARATOR ';') FROM task_records AS tr WHERE tr.callrecordId = tcr.Id and tr.reportUserMobile = tcr.callNumber )AS tasks

			FROM	tel_call_records AS tcr
			WHERE	1=1
			{?AND	tcr.telephonist = #telephonist#}
			{?AND	tcr.callNumber LIKE CONCAT(CONCAT('%',#callNumber#),'%') ESCAPE '/' }
			{?AND	tcr.type = #type#}
			{?AND	tcr.recordId = #tapeCode#}
			{?AND	tcr.hasCheck = #hasCheck#}
			{?AND	tcr.callTime >= #fromTime#}
			{?AND	tcr.callTime <= #toTime#}
			{?AND	tcr.duration >= #fromDuration#}
			{?AND	tcr.duration <= #toDuration#}
			{?AND tcr.id in (SELECT mtc.callRecordId FROM mid_tel_callreason AS mtc WHERE mtc.reasonId = #reasonId# and isDeleted = 0)}
			{?AND tcr.id in (SELECT tr.callrecordId FROM task_records AS tr WHERE tr.taskNo = #taskCode#)}
			ORDER BY tcr.callTime DESC
        ]]>
    </entry>

    <!-- 通话记录统计 -->
    <entry key="service.telcallrecord.count">
        <![CDATA[
			SELECT	SUM(CASE tcr.type WHEN 1 THEN 1 ELSE 0 END) AS callInCount,
					SUM(CASE tcr.type WHEN 2 THEN 1 ELSE 0 END) AS callOutCount,
					SUM(CASE tcr.hasCheck WHEN 1 THEN 1 ELSE 0 END) AS checkedCount,
					SUM(case when (tcr.type = 2 and tcr.isConnect = 0) then 1 else 0 end ) AS callOutMissCount

			FROM	tel_call_records AS tcr

			WHERE	1 = 1
			{?AND	tcr.telephonist = #telephonist#}
			{?AND	tcr.callNumber = #callNumber#}
			{?AND	tcr.type = #type#}
			{?AND	tcr.recordId = #tapeCode#}
			{?AND	tcr.hasCheck = #hasCheck#}
			{?AND	tcr.callTime >= #fromTime#}
			{?AND	tcr.callTime <= #toTime#}
			{?AND	tcr.duration >= #fromDuration#}
			{?AND	tcr.duration <= #toDuration#}
			{?AND 	tcr.id in (SELECT mtc.callRecordId FROM mid_tel_callreason AS mtc WHERE mtc.reasonId = #reasonId#)}
        ]]>
    </entry>

     <!-- 添加通话记录 -->
    <entry key="service.telcallrecord.add">
        <![CDATA[
			Insert into
				`tel_call_records`(`id`,`callId`,`recordId`,`type`,`typeText`,`callNumber`,`callTime`,`source`)
			Values
				(#id#,#callId#,#recordId#,#type#,
					(SELECT value FROM dim_dictionary_items WHERE dictionaryId = (SELECT id FROM dim_dictionary WHERE code = 'CallType' LIMIT 1) AND code = #type#  LIMIT 1),
				#callNumber#,#callTime#,#source#)
        ]]>
    </entry>

    <!-- 更新通话记录，添加通话结束时间 -->
    <entry key="service.telcallrecord.update">
        <![CDATA[
			UPDATE 	tel_call_records
			SET 	{? beginTime = #beginTime# ,}
					{? endTime = #endTime# ,}
				    {? duration = #duration# ,}
				    {? isConnect = #isConnect#,}
				    {? hangup_byself = #hangUp#,}
				    telephonist = #telephonist#,
				    telephonistId = #telephonistId#
			WHERE 	id = #id#
        ]]>
    </entry>

     <!-- 获取通话记录的通话原因 -->
    <entry key="service.telcallrecord.reason">
        <![CDATA[
			SELECT	tc.content AS content,
					tc.id AS reasonId,
					mtcr.callId AS callId

			FROM	mid_tel_callreason AS mtcr inner join tel_callreason AS tc
					on tc.id = mtcr.reasonId

			WHERE	mtcr.callId = #callId#
        ]]>
    </entry>

	<!-- 根据通话记录id获取通话原因关联表数据 -->
    <entry key="sql.query.callreason.bycallid">
        <![CDATA[
			SELECT	mtcr.reasonId
			FROM	mid_tel_callreason AS mtcr
			WHERE	mtcr.callRecordId = #recordId# AND IFNULL(mtcr.isDeleted, 0) = 0
        ]]>
    </entry>

	<!-- 根据通话记录id获取通话原因关联表数据 -->
	<entry key="sql.delete.callreason.bycallid">
		<![CDATA[
			UPDATE mid_tel_callreason SET isDeleted = 1, deletorId = #deletorId#, deleteTime = #deleteTime# WHERE callRecordId = #callRecordId# and reasonId = #reasonId# and IFNULL(isDeleted, 0) = 0
        ]]>
	</entry>

    <!-- 获取全部通话原因 -->
    <entry key="service.telcallreason">
        <![CDATA[
				SELECT	tc.content AS content,
						tc.id AS id,
						tc.isEnabled AS isEnabled,
						tc.sortNo AS sortNo,
						tc.type AS type,
						tc.typeText AS typeText,
						tc.creator AS creator,
						tc.creatorId AS creatorId,
						tc.createTime AS createTime

				FROM	tel_callreason AS tc

				WHERE 	tc.isEnabled = 1
				{?AND	tc.id = #id#}
				{?AND	tc.type = #type#}

				ORDER BY tc.sortNo
        ]]>
    </entry>

    <!-- 字典表获取通话类型 -->
    <entry key="service.telcalltype">
        <![CDATA[
			SELECT ddi.value AS typeText,
				   ddi.code  AS type
		    FROM   dim_dictionary_items AS ddi
		    WHERE  ddi.dictionaryId = (SELECT dd.id AS id FROM dim_dictionary AS dd WHERE dd.code = 'CallType')
        ]]>
    </entry>

</properties>
