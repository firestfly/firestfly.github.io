<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>项目公告SQL文件</comment>
    
    <!-- 分页公告查询  -->
	<entry key="sql.query.notices">
	<![CDATA[
		SELECT  b.id,
				b.projectCode,
				b.takeEffectTime,
				b.lostEffectTime,
				b.level,
				b.content,
				b.contactMobile,
				b.approveStatus,
				b.publisherId,
				b.publishTime,
				b.isDeleted,
				b.deleterid,
				b.deleteTime,
				b.isClosed,
				b.closeUserId,
				b.closeTime,
				b.noticeSource
		FROM biz_project_notice b
		WHERE IFNULL(b.isDeleted, 0) = 0
				{? AND b.takeEffectTime >= #startTime# }
				{? AND b.takeEffectTime <= #endTime# }
				{? AND ((#noticeStatus# = 1 AND b.takeEffectTime > now()) }
				{? OR (#noticeStatus# = 2 AND b.takeEffectTime <= now() AND b.lostEffectTime >= now()) }
				{? OR (#noticeStatus# = 3 AND b.lostEffectTime <= now()) and b.takeEffectTime <= now())  }
				{? AND b.publisherId IN (SELECT t.id FROM vankecrm_organization.sec_user t WHERE t.name LIKE CONCAT(CONCAT('%',#publisher#),'%') ESCAPE '/' )}
				{? AND b.level = #level#}
				{? AND b.projectCode = #projectCode# }
				{? AND b.content LIKE CONCAT(CONCAT('%',#content#),'%') ESCAPE '/' }
				{? AND b.approveStatus = #approveStatus# }
				{? AND b.approveStatus = #approveStatusExt# }
		ORDER BY b.publishTime desc
	]]>
	</entry>
	
	<!-- 根据公告ID查询公告信息  -->
	<entry key="sql.query.notice.byid">
	<![CDATA[
		SELECT
			b.id,
			b.projectCode,
			b.takeEffectTime,
			b.lostEffectTime,
			b.level,
			b.content,
			b.contactMobile,
			b.approveStatus,
			b.publisherId,
			b.publishTime,
			b.isDeleted,
			b.deleterid,
			b.deleteTime,
			b.isClosed,
            b.closeUserId,
            b.closeTime,
            b.noticeSource
		FROM biz_project_notice b
		WHERE b.id = #noticeId#
		      AND IFNULL(b.isDeleted, 0) = 0
		LIMIT 1;
	]]>
	</entry>
	
   <!-- 逻辑删除，只修改删除状态 -->
	<entry key="sql.delete.notice.isdeleted">
	<![CDATA[
     update biz_project_notice set isdeleted =1,deleter = #deleter#,deleterId=#deleterId#,deleteTime=#deleteTime#
     where id = #noticeId#
	]]>
	</entry>
	
	<!-- 修改公告信息 -->	
	<entry key="sql.update.notice">
	UPDATE biz_project_notice
        SET projectCode=#projectCode#,
            lostEffectTime=#lostEffectTime#,
            takeEffectTime=#takeEffectTime#,
            level=#level#,
            content=#content#,
            contactMobile=#contactMobile#,
            approveStatus=#approveStatus#
	WHERE id = #id#
	</entry>

    <!-- 关闭公告 -->
    <entry key="sql.update.notice.close">
    <![CDATA[
        UPDATE `biz_project_notice` SET approveStatus = #approveStatus#, `isClosed` = 1, closeUserId = #userId#, closeTime = now() where id = #noticeId#
    ]]>
    </entry>
	
	<!-- 修改公告状态 -->
	<!--<entry key="sql.update.notice.status.byid">-->
	<!--<![CDATA[-->
	<!--update biz_project_notice set noticeStatus=#status#,-->
 	<!--approveStatus = #approveStatus#-->
	<!--where id = #noticeid#-->
		<!--]]>-->
	<!--</entry>-->

	<!-- 新增一条公告信息 -->
	<entry key="sql.insert.notice">
	<![CDATA[
	    insert into biz_project_notice
	    (`id`,
         `projectCode`,
         `takeEffectTime`,
         `lostEffectTime`,
         `level`,
         `content`,
         `contactMobile`,
         `approveStatus`,
         `publisherId`,
         `publishTime`,
         `noticeSource`,
         `isDeleted`)
        VALUES
	    (#id#,#projectCode#,#takeEffectTime#,#lostEffectTime#,#level#,
	    #content#,#contactMobile#,
	    #approveStatus#,#publisherId#,#publishTime#,#noticeSource#,0)
		]]>
	</entry>

	<!-- 查询一个项目下有无公告 -->
	<entry key="sql.query.notice.ishasnotice">
		<![CDATA[
			SELECT COUNT(1) from biz_project_notice b
			where projectCode=#projectCode#
			and isdeleted = 0
			AND b.takeEffectTime <= now()
			AND b.lostEffectTime >= now()
			and b.approveStatus=2
		]]>
	</entry>
	
	<!-- 公告审核 -->
	<entry key="sql.query.notice.approve">
		<![CDATA[
			UPDATE biz_project_notice bpn SET bpn.approveStatus = #approveStatus# WHERE bpn.id = #id#
		]]>
	</entry>

	<!-- 公告审核 -->
	<entry key="sql.insert.noticeLog">
		<![CDATA[
			insert into biz_project_notice_log(`id`,`notice_id`,`logtime`,`content`,`notice_detail`)
			VALUES(null,#notice_id#,#logTime#,#content#,#notice_detail#)
		]]>
	</entry>

	<!-- 公告审核 -->
	<entry key="sql.query.noticeLog">
		<![CDATA[
			select notice_id as noticeId,
			logtime as logtime,
			content as content,
			notice_detail  as noticeDetail
			from biz_project_notice_log where notice_id=#noticeId#
		]]>
	</entry>
</properties>