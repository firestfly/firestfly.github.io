<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <comment>客户信息sql</comment>

    <!-- 查询客户信息(指挥中心) -->
    <entry key="service.query.customer.queryPendingCustomer">
        <![CDATA[
        select *from (SELECT a.customerId, a.houseId,a.projectId,
        b.name as houseName,
        c.id AS pendingId,c.sex,c.createTime,c.crmCustomerId,c.fullName,
        c.from as fromCode,c.operator as operatorCode,
        c.mainMobile,
        (select GROUP_CONCAT(contentId) from tmp_cust_hobbies_pending where customerId=a.customerId GROUP BY customerId) as tags,
        (select GROUP_CONCAT(identity) from tmp_cust_specialidentity_pending where customerId=a.customerId GROUP BY customerId) as identities,
        (select GROUP_CONCAT(relationType) from tmp_customer_house_pending where customerId=a.customerId GROUP BY customerId) as relationType
        FROM tmp_customer_house_pending a
        LEFT JOIN main_house b on b.id=a.houseId
        INNER JOIN tmp_customer_pending c on c.id=a.customerId
        WHERE 1=1
        AND c.approveStatus = 1
        and a.houseId in
        (select houseId from mid_project_house b where b.gridId in(select id from main_grid where managerId = #userId#))
        {? and c.createTime >= #startTime# }
        {? and c.createTime <= #endTime# }
        {? and c.from = #from# }
        {? and c.operator = #operator# }
        {? and a.projectId = #projectId# }
    UNION
        SELECT a.customerId, a.houseId,a.projectId,
        b.name as houseName,
        c.id AS pendingId,c.sex,c.createTime,c.crmCustomerId,c.fullName,
        c.from as fromCode,c.operator as operatorCode,
        c.mainMobile,
        (select GROUP_CONCAT(contentId) from tmp_cust_hobbies_pending where customerId=a.customerId GROUP BY customerId) as tags,
        (select GROUP_CONCAT(identity) from tmp_cust_specialidentity_pending where customerId=a.customerId GROUP BY customerId) as identities,
        (select GROUP_CONCAT(relationType) from tmp_customer_house_pending where customerId=a.customerId GROUP BY customerId) as relationType
        FROM tmp_customer_house_pending a
        LEFT JOIN main_house b on b.id=a.houseId
        INNER JOIN tmp_customer_pending c on c.id=a.customerId
        WHERE 1=1
        AND c.approveStatus = 1
        and a.projectId in
        (select d.organizationId from mid_organization_user d INNER JOIN tree_organization e on d.organizationId=e.id where e.levelType=4 and userId=#userId#)
        {? and c.createTime >= #startTime# }
        {? and c.createTime <= #endTime# }
        {? and c.from = #from# }
        {? and c.operator = #operator# }
        {? and a.projectId = #projectId# }
) as temp
        GROUP BY  temp.pendingId
        ORDER BY temp.createTime desc
    ]]>
    </entry>

    <!-- 查询客户临时表已审核数据-->
    <entry key="service.query.customer.queryPendingCustomer.approved">
        <![CDATA[
         select *from (SELECT a.customerId, a.houseId,a.projectId,
        b.name as houseName,
        c.id AS pendingId,c.sex,c.createTime,c.crmCustomerId,c.fullName,
        c.from as fromCode,c.operator as operatorCode,
        c.mainMobile,
        (select GROUP_CONCAT(contentId) from tmp_cust_hobbies_pending where customerId=a.customerId GROUP BY customerId) as tags,
        (select GROUP_CONCAT(identity) from tmp_cust_specialidentity_pending where customerId=a.customerId GROUP BY customerId) as identities,
        (select GROUP_CONCAT(relationType) from tmp_customer_house_pending where customerId=a.customerId GROUP BY customerId) as relationType
        FROM tmp_customer_house_pending a
        LEFT JOIN main_house b on b.id=a.houseId
        INNER JOIN tmp_customer_pending c on c.id=a.customerId
        WHERE 1=1
        AND c.approveStatus <> 1
        and a.houseId in
        (select houseId from mid_project_house b where b.gridId in(select id from main_grid where managerId = #userId#))
        {? and c.createTime >= #startTime# }
        {? and c.createTime <= #endTime# }
        {? and c.from = #from# }
        {? and c.operator = #operator# }
        {? and a.projectId = #projectId# }
    UNION
        SELECT a.customerId, a.houseId,a.projectId,
        b.name as houseName,
        c.id AS pendingId,c.sex,c.createTime,c.crmCustomerId,c.fullName,
        c.from as fromCode,c.operator as operatorCode,
        c.mainMobile,
        (select GROUP_CONCAT(contentId) from tmp_cust_hobbies_pending where customerId=a.customerId GROUP BY customerId) as tags,
        (select GROUP_CONCAT(identity) from tmp_cust_specialidentity_pending where customerId=a.customerId GROUP BY customerId) as identities,
        (select GROUP_CONCAT(relationType) from tmp_customer_house_pending where customerId=a.customerId GROUP BY customerId) as relationType
        FROM tmp_customer_house_pending a
        LEFT JOIN main_house b on b.id=a.houseId
        INNER JOIN tmp_customer_pending c on c.id=a.customerId
        WHERE 1=1
        AND c.approveStatus <> 1
        and a.projectId in
        (select d.organizationId from mid_organization_user d INNER JOIN tree_organization e on d.organizationId=e.id where e.levelType=4 and userId=#userId#)
        {? and c.createTime >= #startTime# }
        {? and c.createTime <= #endTime# }
        {? and c.from = #from# }
        {? and c.operator = #operator# }
        {? and a.projectId = #projectId# }
) as temp
        GROUP BY  temp.pendingId
        ORDER BY temp.createTime desc
    ]]>
    </entry>

    <!-- 审批临时表数据 -->
    <entry key="service.approve.customer.PendingCustomer">
        <![CDATA[
			UPDATE
				tmp_customer_pending
			SET
				approveStatus = #approve#,
				crmCustomerId = #crmCustomerId#,
				modifyTime = NOW(),
				modifierId = #modifierId#,
				modifier = #modifier#
			WHERE
				id = #id#
    ]]>
    </entry>

    <!-- 审批临时表数据(未通过) -->
    <entry key="service.cancel.customer.PendingCustomer">
        <![CDATA[
			UPDATE
				tmp_customer_pending
			SET
				approveStatus = #approve#,
				modifyTime = NOW(),
				modifierId = #modifierId#,
				modifier = #modifier#
			WHERE
				id = #id#
    ]]>
    </entry>


    <!-- 根据客户id查询客户基本信息 -->
    <entry key="service.query.customer.queryPendingBasic">
        <![CDATA[
			SELECT
				id as customerId,
				id as pendingId,
				crmCustomerId,
				firstName,
				lastName,
				fullName,
				sex,
				customerType,
				mainMobile,
				standbyMobile,
				homeTel,
				officeTel,
				contactAddr,
				affiliation,
				certificateType,
				certificateId,
			    `from` as fromCode,
			    operator as operatorCode
			FROM
				tmp_customer_pending a
			WHERE
				IFNULL(isDeleted, 0) = 0 AND id = #customerId#
			LIMIT 1
	     ]]>
    </entry>


    <!-- 根据客户id查询客户详情信息 -->
    <entry key="service.query.customer.queryPendingDetails">
        <![CDATA[
			SELECT
				d.id,
				postCode,
				email,
				qq,
				weChat,
				birthday,
				blood,
				occupation,
				registerAddr,
				d.contactAddr,
				company,
				companyAddr,
				urgencyContacts,
				urgencyPhoneNumber,
				urgencyMobileNumber,
				remark
			FROM
				tmp_customer_detail_pending d
					INNER JOIN
				tmp_customer_pending c ON d.id = c.id
			WHERE
				IFNULL(c.isDeleted, 0) = 0 AND d.id = #customerId#
				LIMIT 1
	     ]]>
    </entry>



    <!-- 查询客户与房屋关系(指挥中心) -->
    <entry key="service.query.customer.queryPendingCustomerHouseRelation">
        <![CDATA[
        select a.houseId, a.customerId, a.relationType,
        b.name as houseName
        from tmp_customer_house_pending a INNER JOIN main_house b on b.id=a.houseId
        where 1=1
        and a.customerId=#customerId#
        and a.houseId=#houseId#
    ]]>
    </entry>

    <!-- 查询客户特殊身份(指挥中心) -->
    <entry key="service.query.customer.queryPendingCustomerSpecialIdentity">
        <![CDATA[
         SELECT
                id,
                customerId,
                identity,
                identityText,
                beginDate,
                endDate,
                duration
            FROM
                tmp_cust_specialidentity_pending
            WHERE
                IFNULL(isDeleted, 0) = 0
                    AND customerId = #customerId#;
    ]]>
    </entry>

    <!-- 查询客户兴趣爱好(指挥中心) -->
    <entry key="service.query.customer.queryPendingCustomerHobby">
        <![CDATA[
         SELECT
                id, customerId, contentId, contentText
            FROM
                tmp_cust_hobbies_pending
            WHERE
                IFNULL(isDeleted, 0) = 0
                    AND customerId = #customerId#
    ]]>
    </entry>

    <!-- 更新审批状态 -->
    <entry key="service.update.pendingCustomer.approveStatus">
        <![CDATA[
        update tmp_customer_pending set approveStatus='2'
        where crmCustomerId=#crmCustomerId# and id=#customerId#
    ]]>
    </entry>




    <!-- 更新审批状态并设置客户ID -->
    <entry key="sql.update.customer.approveStatus">
        <![CDATA[
        update tmp_customer_pending set approveStatus='2',crmCustomerId=#crmCustomerId#
        where id=#customerId#
    ]]>
    </entry>







</properties>
