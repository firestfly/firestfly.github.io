<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>话务人员信息查询</comment>
	
    
    	<!-- 获取管理中心列表 -->
    <entry key="sql.organizations">
        <![CDATA[
			SELECT
				id AS id,
				`name` AS name 
			FROM 
				tree_organization AS t 
			WHERE
				t.levelType = 3
			ORDER BY name
        ]]>
    </entry>
    
        <!-- 获取项目列表 -->
    <entry key="sql.projects">
        <![CDATA[
			SELECT
				id AS id,
				`name` AS name 
			FROM 
				tree_organization AS t 
			WHERE
				t.levelType = 4
			{?AND	t.parentId = #organizationId#}
        ]]>
    </entry>
    
        <!-- 获取网格列表 -->
    <entry key="sql.girds">
        <![CDATA[
			SELECT 
				id AS id,`name` AS name 
			FROM 
				main_grid AS mg 
			WHERE 
				1 = 1
			{?AND	mg.projectId = #projectId#}
        ]]>
    </entry>

	<!-- 获取当前登陆人所属项目 -->
	<entry key="sql.projects.byuser">
		<![CDATA[
        select * from (
        (
            select b.id,b.name,c.code,c.oldId,c.shortName,c.address from mid_organization_user a
            INNER  JOIN tree_organization b
            on a.organizationId=b.id
            LEFT JOIN main_project c on c.id=b.id
            where 1=1
            and a.userid=#userId#
            and b.leveltype=4
            and IFNULL(a.isDeleted,0)=0
            {? AND b.name LIKE CONCAT(CONCAT('%',#projectName#),'%') ESCAPE '/' }
            {? AND b.parentId = #parentId# }
        )
        UNION
         (
            select  c.id,c.name,b.code,b.oldId,b.shortName,b.address from main_grid a
            INNER  JOIN main_project b on a.projectId=b.id
            LEFT JOIN  tree_organization c on c.id=b.id
            WHERE 1=1
            and a.managerId = #userId#
            and c.leveltype=4
            and IFNULL(a.isDeleted,0)=0
            {? AND c.parentId = #parentId# }
            {? AND b.name LIKE CONCAT(CONCAT('%',#projectName#),'%') ESCAPE '/' }
         )
        ) tmp
        ORDER BY tmp.name;
        ]]>
	</entry>





    <!-- 查询一个用户拥有的管理中心和服务公司权限 -->
    <entry key="sql.query.mcAndCompany">
        <![CDATA[
			select b.id,b.name,b.leveltype from mid_organization_user a INNER JOIN tree_organization b on a.organizationId=b.id
            where a.userId=#userId#
            and b.levelType in (3,8)
			{? AND b.name LIKE CONCAT(CONCAT('%',#name#),'%') ESCAPE '/' }
			GROUP BY b.id
        ]]>
    </entry>


    <!-- 查询一个用户拥有房屋权限（根据项目权限和网格获取） -->
    <entry key="sql.query.houseByUserId">
        <![CDATA[
         select * from (
            (select a.id,a.`name`,a.`code` from main_house a where projectId in
            (select a.organizationId from mid_organization_user a INNER JOIN tree_organization b on b.id=a.organizationId
            where b.levelType=4
            and IFNULL(a.isDeleted,0)=0
            and a.userid= #userId# )
            and IFNULL(isDeleted,0)=0
            {? and a.name LIKE CONCAT(CONCAT('%',#houseName#),'%') ESCAPE '/' }
            and a.projectId=#projectId#
            )
            UNION
            (
            select a.id,a.`name` ,a.`code` from main_house a INNER JOIN mid_project_house b on a.id=b.houseId
            where b.gridId in (select id from main_grid where managerId =#userId#)
            and IFNULL(a.isDeleted,0)=0
            {? and a.name LIKE CONCAT(CONCAT('%',#houseName#),'%') ESCAPE '/' }
            and a.projectId=#projectId#
            )
        ) tmp
        ORDER BY tmp.code
        ]]>
    </entry>



</properties>