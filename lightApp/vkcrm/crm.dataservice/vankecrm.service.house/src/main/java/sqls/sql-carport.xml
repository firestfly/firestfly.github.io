<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>车位信息查询</comment>
	
	<!-- 查询项目下的车场信息 -->
	<entry key="sql.carpark.queryAll">
		<![CDATA[
		SELECT
            * 
        FROM
            main_carpark cp
        WHERE
             EXISTS (select 1 from tree_organization 
             where id in (select organizationId from mid_organization_user where userId= #userId#  and IFNULL(isDeleted, 0) = 0 and status = 1)
              AND levelType = 4 AND IFNULL(isDeleted, 0) = 0 AND id = #projectId#)
                AND cp.projectId = #projectId# AND IFNULL(cp.isDeleted, 0) = 0
        ]]>
	</entry>
	
	<!-- 查询项目下指定车场的车位分组信息 -->


	<entry key="sql.carportGroup.queryAll">
		<![CDATA[
		SELECT
            cg.id,
            cg.name,
            p.id AS 'projectId',
            p.name AS 'projectName',
            cg.carparkId,
            (select count(1) from main_carport cp where cp.groupId = cg.id) as 'count'
        FROM
            dim_carport_group cg
                INNER JOIN 

            main_project p ON cg.projectId = p.id
        WHERE 
             EXISTS (select 1 from tree_organization 
             where id in (select organizationId from mid_organization_user where userId= #userId#  and IFNULL(isDeleted, 0) = 0 and status = 1)
              AND levelType = 4 AND IFNULL(isDeleted, 0) = 0 AND id = #projectId#) 
            AND IFNULL(cg.isDeleted, 0) = 0 AND IFNULL(p.isDeleted, 0) = 0
                AND p.id = #projectId# AND cg.carparkId = #carparkId# 
        ]]>
	</entry>
	
	<!-- 查询项目下指定车场的是否存在未分组的车位 -->
	<entry key="sql.carportGroup.existUngroup">
		<![CDATA[
			select count(1) from main_carport cp where ((cp.projectId=#projectId# and cp.carparkId=#carparkId#  and IFNULL(cp.isDeleted, 0)=0 and cp.groupId is null)
			 or (cp.projectId=#projectId# and cp.carparkId=#carparkId#  and IFNULL(cp.isDeleted, 0)=0 
			 and cp.groupId not in (select id from dim_carport_group cg where cg.projectId=#projectId# and cg.carparkId=#carparkId# and IFNULL(cg.isDeleted, 0)=0 ))) 
			 and EXISTS (select 1 from tree_organization 
			             where id in (select organizationId from mid_organization_user where userId=#userId# and IFNULL(isDeleted, 0) = 0 and status = 1)
			              AND levelType = 4 AND IFNULL(isDeleted, 0) = 0 AND id = #projectId#) 
        ]]>
	</entry>
	
    <!-- 查询项目下指定车场的哪个组中能找到指定的车位 -->
    <entry key="sql.carportGroup.query">
        <![CDATA[
		SELECT
            case when c.groupId is null then null 
			else (select id from dim_carport_group cg where cg.projectId=#projectId# and cg.carparkId=#carparkId# and IFNULL(cg.isDeleted,0)=0 and cg.id=c.groupId limit 1) 
			end as groupId
        FROM
            main_carport c 
        WHERE
            c.projectId=#projectId# AND c.carparkId=#carparkId# AND IFNULL(c.isDeleted, 0) = 0 
			 and EXISTS (select 1 from tree_organization 
			             where id in (select organizationId from mid_organization_user where userId=#userId# and IFNULL(isDeleted, 0) = 0 and status = 1)
			              AND levelType = 4 AND IFNULL(isDeleted, 0) = 0 AND id = #projectId#) 
			    AND c.name LIKE CONCAT(CONCAT('%', #carportName#), '%') ESCAPE '/'          
                order by c.groupId limit 1


        ]]>
    </entry>

    <!-- 查询项目下指定车场的车位组中所有车位信息 -->

    <entry key="sql.carport.group.queryAll">
        <![CDATA[
		SELECT
            c.id, c.name, GROUP_CONCAT(mc.fullName) as owner, GROUP_CONCAT(mc.mainMobile) as 'mobilePhone'
        FROM
            main_carport c 
				LEFT JOIN mid_carport_customer mcc on mcc.carportid=c.id 



				LEFT JOIN main_customer mc on mc.id=mcc.customerid 
        WHERE
            c.projectId=#projectId# AND c.carparkId=#carparkId# AND c.groupId = #groupId# AND IFNULL(c.isDeleted, 0) = 0 
			 and EXISTS (select 1 from tree_organization 
			             where id in (select organizationId from mid_organization_user where userId=#userId# and IFNULL(isDeleted, 0) = 0 and status = 1)
			              AND levelType = 4 AND IFNULL(isDeleted, 0) = 0 AND id = #projectId#) 
			    AND c.name LIKE CONCAT(CONCAT('%', #carportName#), '%') ESCAPE '/'         
                AND IFNULL(mcc.isDeleted,0) = 0 
                AND IFNULL(mc.isDeleted,0) = 0
                GROUP BY c.id
                order by c.name

        ]]>
    </entry>

    <!--查询项目下指定车场的未分组的车位-->

    <entry key="sql.carport.ungroup.queryAll">
        <![CDATA[
            SELECT
            c.id, c.name,GROUP_CONCAT(mc.fullName) as owner
            FROM
                main_carport c
                    LEFT JOIN mid_carport_customer mcc on mcc.carportid=c.id
                    LEFT JOIN main_customer mc on mc.id = mcc.customerid and IFNULL(mcc.isDeleted, 0) = 0
            WHERE
                ((c.projectId=#projectId# and c.carparkId=#carparkId#  and IFNULL(c.isDeleted,0)=0 and c.groupId is null)
                 or (c.projectId=#projectId# and c.carparkId=#carparkId#  and IFNULL(c.isDeleted,0)=0
                 and c.groupId not in (select id from dim_carport_group cg where cg.projectId=#projectId# and cg.carparkId=#carparkId# and IFNULL(cg.isDeleted,0)=0 )))
                 and EXISTS (select 1 from tree_organization
                             where id in (select organizationId from mid_organization_user where userId=#userId# and IFNULL(isDeleted, 0) = 0 and status = 1)
                              AND levelType = 4 AND IFNULL(isDeleted, 0) = 0 AND id = #projectId#)
                    AND c.name LIKE CONCAT(CONCAT('%', #carportName#), '%') ESCAPE '/'
                AND IFNULL(mc.isDeleted,0) = 0
                GROUP BY c.id
                order by c.name
        ]]>
    </entry>

    <!--新增车位分组-->
    <entry key="sql.carport.addgroup">
        <![CDATA[
        INSERT INTO dim_carport_group
        (`id`,`projectId`,`name`,`creator`,`creatorId`,`createTime`)
        VALUES
        (#id#, #projectId#, #name#, #creator#, #creatorId#, now())
        ]]>
    </entry>

    <!--分组中新增车位-->
    <entry key="sql.carportGroup.addCarports">
        <![CDATA[
        INSERT INTO mid_carport_group(group_id, carport_id)
        SELECT * FROM (SELECT #groupId#, #carportId#) AS tmp
        WHERE NOT EXISTS
            (SELECT 1 FROM mid_carport_group
                WHERE groupId = #groupId#
                AND carportId = #carportId#)
        ]]>
    </entry>

    <!-- 根据车位id获取车位详情-->
    <entry key="sql.query.carportInfoById">
        <![CDATA[
		select t1.id,t1.code,t1.assistantCode,t2.oldid,
        t1.name,t1.projectId,t1.status,t1.startTime,t1.contactsId,
        t1.area,t2.name as projectName,
        t1.parkingtype as parkingtype,
        t1.equityType as equityType
        from main_carport t1
				LEFT JOIN main_project t2 on t1.projectId = t2.id
        WHERE
         t1.isDeleted=0 and
         t1.id=#id#
        LIMIT 1
	    ]]>
    </entry>

    <!-- 车位过户-->
    <entry key="sql.update.carportTransfer">
        <![CDATA[
		update main_carport set ownerId = #newId#,
		 modifierId=#modifierId#,
		 modifier=#modifier#,
		 modifyTime=now()
        where id=#carportId#
	    ]]>
    </entry>

    <!-- 查询一个车位下现在的主人-->
    <entry key="sql.query.carportCustomer.relation">
        <![CDATA[
		select * from mid_carport_customer where carportId=#carportId#
		and isdeleted=0
	    ]]>
    </entry>

    <!-- 查询一个车位下的主人的详细信息(姓名、手机号码)-->
    <entry key="sql.query.carportCustomerInfo.relation">
        <![CDATA[
		select mc.id as customerId,mc.fullName as owner,mc.mainMobile as mainMobile
		from mid_carport_customer mcc,main_customer mc where
		mcc.customerId=mc.id
		and mcc.carportId=#id#
		and mcc.isdeleted=#isdeleted#

	    ]]>
    </entry>

    <!-- 逻辑删除一个车位和主人的关系记录-->
    <entry key="sql.remove.carportCustomer.relation">
        <![CDATA[
		update mid_carport_customer set isDeleted=1,
		deletor=#deletor#,
		deletorId=#deletorId#,
		deleteTime=now()
        where id=#id#
	    ]]>
    </entry>


    <!-- 通过车位ID更新车位信息-->
    <entry key="sql.update.carportInfoById">
        <![CDATA[
		update main_carport mc set
		{? mc.status=#status#,}
        {? mc.contactsId=#contactsId#,}
        {? startTime=#startTime#,}
        mc.modifier=#modifier#,
		mc.modifierId=#modifierId#,
        mc.modifyTime=NOW()
        where id =#id#
	    ]]>
    </entry>
    
	<!--查询车位信息按项目、车位编码、车场编码-->
    <entry key="sql.query.carport">
        <![CDATA[
           SELECT 
			  cp.id,
			  cp.code,
			  cp.assistantCode,
			  cp.name,
			  cp.carparkId,
			  cp.projectId,
			  cp.parkingType,
			  cp.equityType,
			  cp.area,
			  cp.contactsId,
			  cp.STATUS,
			  cp.startTime,
			  cp.modifier,
			  cp.modifierId,
			  cp.modifyTime,
			  cp.isDeleted,
			  cp.deleter,
			  cp.deleterId,
			  cp.deleteTime,
			  cp.lotcode,
			  cp.groupId,
			  cp.groupModifierId,
			  cp.groupModifyTime,
			  ck.name AS carparkName,
  			  p.code AS projectCode,
  			  p.name AS porjectName
			FROM
			  main_carport cp 
			  LEFT JOIN main_carpark ck ON cp.carparkId = ck.id
  			  LEFT JOIN main_project p ON cp.projectId = p.id
			  WHERE 1=1
			  {? AND cp.code in ($carportCodes$)}
			  {? AND cp.code = #carportCode#}
			  {? AND cp.lotcode = #carparkCode#}
			  {? AND p.code = #projectCode#}
			  {? AND cp.modifyTime >=  #modifyTime# }
	    	  {? AND cp.modifyTime <=  #timestamp# }
        ]]>
    </entry>
</properties>