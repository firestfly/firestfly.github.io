<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <comment>房屋信息sql</comment>

    <!--查询楼层-->
    <entry key="sql.query.floor">
        <![CDATA[
        SELECT DISTINCT
            floor
        FROM
            mid_project_house ph
        WHERE
            ph.projectId = #projectId#
                AND buildingId = #buildingId#
                AND IFNULL(unitId,'') = IFNULL(#unitId#, '')
        ORDER BY floor
        ]]>
    </entry>

    <!--检查该楼栋下是否包含单元-->
    <entry key="sql.exists.unit">
        <![CDATA[
        SELECT
            COUNT(1)
        FROM
            mid_project_house ph
        WHERE
            ph.projectId = #projectId#
                AND buildingId = #buildingId#
                AND IFNULL(unitId,'') = IFNULL(#unitId#, '')
                {? AND ph.gridId = #gridId# }
        ]]>
    </entry>

    <!--获取该楼层的所有房屋-->
    <entry key="sql.query.house.byfloor">
        <![CDATA[
        SELECT
            h.id AS 'houseId',
            h.parentId,
            h.isSubRoom,
            h.isVirtual,
            h.isCombine,
            m.mergeToHouseId,
            h.name AS 'houseName',
            h.roomNumber AS 'roomNumber',
            h.status,
            h.statusText,
            h.hasSubroom,
            IFNULL((SELECT
                    GROUP_CONCAT(mc.fullName)
                FROM
                    mid_customer_house cb
                        INNER JOIN
                    main_customer mc ON cb.customerId = mc.id
                WHERE
                    cb.houseId = h.id
                    and IFNULL(cb.isDeleted,0)=0
                        AND cb.relationType = 1),'') as 'owner'
        FROM
            mid_project_house ph
                INNER JOIN main_house h ON ph.houseId = h.id AND h.isDeleted = 0
                LEFT JOIN mid_house_merge m ON m.houseId = h.id AND m.isDeleted = 0
        WHERE
            ph.projectId = #projectId#
                AND ph.buildingId = #buildingId#
                AND IFNULL(ph.unitId,'') = IFNULL(#unitId#, '')
                AND ph.floor = #floor#
                AND h.isDeleted = 0
                {? AND ph.gridId = #gridId# }
        ORDER BY h.roomNumber
        ]]>
    </entry>

    <!--查询当前用户所属的网格-->
    <entry key="sql.query.grid.id">
        <![CDATA[
        SELECT
            id
        FROM
            main_grid
        WHERE
            managerId = #managerId#
            AND IFNULL(isDeleted, 0) = 0
            limit 1
        ]]>
    </entry>


    <!--查询当前用户所属的网格-->
    <entry key="sql.query.grid.id.inProject">
        <![CDATA[
        SELECT
            id
        FROM
            main_grid
        WHERE
            managerId = #managerId#
            AND projectId = #projectId#
            AND IFNULL(isDeleted, 0) = 0
            limit 1
        ]]>
    </entry>

    <!--查询楼栋所属的项目-->
    <entry key="sql.query.project.by.building">
        <![CDATA[
        SELECT projectId FROM mid_project_house WHERE buildingId = #buildingId#  LIMIT 1
        ]]>
    </entry>



    <!--查询当前用户所属的网格的项目ID集合-->
    <entry key="sql.query.projectId.byGrid">
        <![CDATA[
        select projectId from main_grid where managerId=#userId#
        ]]>
    </entry>




    <!-- 获取房屋基本信息 -->
    <entry key="sql.query.house.basic">
        <![CDATA[
        SELECT
            a.id,
            a.code,
            a.parentId,
            a.name,
            a.assistCode,
            a.projectId,
            (select name from main_project where id = a.projectId) as 'projectName',
            a.buildingCode,
            a.buildingName,
            a.unit,
            a.floor,
            a.roomNumber,
            a.status,

            a.equityType,

            a.contactsId,
            a.contactsName,
            a.contactsMobile,
            a.hasSubRoom,
            a.isSubRoom,
            a.isVirtual,
            a.isCombine,
            a.broadband,

            a.deliverTime,
            a.checkInTime,
            a.isSecondhand,
            a.modifier,
            a.modifierId,
            a.modifyTime,
            a.isDeleted,
            a.deleter,
            a.deleterId,
            a.deleteTime
        FROM
            main_house a
        WHERE
            a.isDeleted = 0 AND a.id = #houseId#
	    ]]>
    </entry>
    
     <!-- 获取房屋的详细信息-->
    <entry key="sql.query.house.detail">
        <![CDATA[
           SELECT
            h.id,
            h.address,
            h.province,
            h.city,
            h.district,
            h.buildingNo,
            h.floor,
            h.unit,
            h.orientation,
            h.roomCount,
            h.hallCount,
            h.kitchenCount,
            h.isSubsidiary,
            h.toiletCount,
            h.areaOfPreSale,
            h.builtUpArea,
            h.actualConstructionArea,
            h.practicalUse,
            h.preSaleConstructionArea,
            h.propertyArea,
            h.measuredBasementArea,
            h.terraceArea,
            h.setArea,
            h.measuredPoolArea,
            h.gardenArea,
            h.basementArea,
            h.fieldMeasuredArea,
            h.poolArea,
            h.garageArea,
            h.salesUnitPrice,
            h.referenceServiceCharge,
            h.layout
        FROM
            main_house_detail h
                INNER JOIN
            main_house mh ON h.id = mh.id
        WHERE
            IFNULL(mh.isDeleted,0) = 0 AND h.id = #houseId#
        ]]>
    </entry>

    <!-- 根据房屋ID,修改房屋状态 -->
    <entry key="sql.update.house.status">
    <![CDATA[
	   	UPDATE main_house SET 
		contactsId = #contactsId#,
		contactsName = (select fullName from main_customer where id = #contactsId#),
		contactsMobile = (select mainMobile from main_customer where id = #contactsId#),
	    {? status = #status#,}
		isSecondhand = #isSecondhand#,
		broadband = #broadband#,
		checkInTime = #checkInTime#
		WHERE id = #id#
	]]>
    </entry>

    <!--根据项目ID,楼栋ID,房屋名称关键字，模糊查询房屋信息-->
    <entry key="sql.search.house">
    <![CDATA[
		SELECT 
			h.id            as houseId,
			h.name          as houseName,
			h.code          as houseCode,
 			ph.buildingId,
 			ph.buildingName,
 			ph.buildingCode,
 			p.id            as projectId,
 			p.name          as projectName,
 			p.code          as projectCode,
 			g.managerName,
 			h.deliverTime,
 			p.isOuter
 			FROM main_house h
 			inner join mid_project_house ph on h.id = ph.houseId
 			inner join main_project p on p.id = ph.projectId 
 			left join main_grid g on ph.gridId = g.id
 			where IFNULL(h.isDeleted, 0) = 0
           	and ph.projectId = #projectId#
           	AND ph.buildingId = #buildingId#
        	{? AND h.name like CONCAT(CONCAT('%',#houseName#),'%') ESCAPE '/' }
        	order by  houseName desc
		 	LIMIT 20
    ]]>
    </entry>
    
    <!-- 根据房屋ID,获取子房屋信息 -->
	<entry key="sql.query.subhouse.byhouseid">
	<![CDATA[
		select a.id            as houseId,
		       a.name          as houseName,
		       a.code          as houseCode,
		       a.roomNumber    AS roomNumber,
		       a.checkInTime,
		       a.contactsName,
		       a.status,
		       a.statusText,
		       hd.propertyArea,
		       c.fullName      as owner
		  From main_house a
		  LEFT JOIN main_customer c      on c.id = a.contactsId
		  left join main_house_detail hd on hd.id = a.id
		 where a.parentId = ?
		   and IFNULL(a.isSubroom, 1) = 1
		   and IFNULL(a.isdeleted, 0) = 0
		 order by a.name
	]]>
	</entry>

    <!-- 查询主房屋下拥有多少子房屋 -->
    <entry key="sql.count.subHouse">
        <![CDATA[
			SELECT COUNT(1) AS ts FROM main_house a where a.parentId = ? and a.isdeleted = 0
        ]]>
    </entry>
    <!-- 查询主房屋下拥有多少子房屋 -->
    <entry key="sql.count.subHouse1">
        <![CDATA[
			SELECT COUNT(1) AS ts FROM main_house a where a.parentId = ? 
        ]]>
    </entry>

    <!-- 插入子房屋基本信息 -->
    <entry key="sql.insert.subHouse.basic">
        <![CDATA[
		INSERT INTO main_house (id, code, parentId, name, assistCode, projectId, buildingCode, buildingName,
        unit, floor, roomNumber, status, statusText,equityType,equityTypeText,contactsName, contactsMobile, 
		broadband,broadbandText,checkInTime,deliverTime,hasSubroom, isSubroom,isVirtual,isSecondhand,isDeleted)
        VALUES 
        (#id#, #code#, #parentId#, #name#, #assistCode#, #projectId#, #buildingCode#, #buildingName#,
         #unit#, #floor#, #roomNumber#, #status#,#statusText#,#equityType#,#equityTypeText#,#contactsName#, #contactsMobile#,
		 #broadband#,#broadbandText#,#checkInTime#,#deliverTime#,0,1,0,0,0)
        ]]>
    </entry>

    <!-- 插入子房屋详细信息 -->
    <entry key="sql.insert.subHouse.details">
        <![CDATA[
		INSERT INTO main_house_detail (id, address, province, city, district, buildingNo, floor, unit,
                orientation, roomCount, hallCount, kitchenCount, toiletCount, areaOfPreSale,
                builtUpArea, actualConstructionArea, preSaleConstructionArea, propertyArea,
                measuredBasementArea, terraceArea, setArea, measuredPoolArea, gardenArea,
                basementArea, fieldMeasuredArea, poolArea, garageArea, salesUnitPrice, referenceServiceCharge, isSubsidiary, practicalUse)
        VALUES (#id#, #address#, #province#, #city#, #district#, #buildingNo#, #floor#, #unit#,
                #orientation#, #roomCount#, #hallCount#, #kitchenCount#, #toiletCount#, #areaOfPreSale#,
                #builtUpArea#, #actualConstructionArea#, #preSaleConstructionArea#, #propertyArea#, #measuredBasementArea#, #terraceArea#, #setArea#, #measuredPoolArea#, #gardenArea#,
                #basementArea#, #fieldMeasuredArea#, #poolArea#, #garageArea#, #salesUnitPrice#, #referenceServiceCharge#, #isSubsidiary#, #practicalUse#)
	    ]]>
    </entry>

    <!-- 修改主房屋是否拥有子房屋 -->
    <entry key="sql.update.house.hasSubRoom">
        <![CDATA[
    	UPDATE main_house
        SET
            hasSubRoom = #hasSubRoom#
        WHERE
            id = #houseId#
	    ]]>
    </entry>

    <!-- 根据项目编号获取所有无客户信息的房屋 -->
    <entry key="roomsExport.list">
        <![CDATA[
       SELECT mr.belongto_projectname,
       mr.belongto_projectcode,mr.belongto_building,
       mr.building_name,mr.building_code
       FROM main_building as mr where mr.belongto_projectcode=#belongToProjectCode#
    ]]>
    </entry>

    <!-- 根据项目编号、网格查询客与房/车的修改记录 -->
    <entry key="showCustAndRoomsInfo.list">
        <![CDATA[
        select mr.parent_buildingid as parentbuildingId,mr.building_code as buildingCode,mc.name as name
        ,mc.customer_code as customerCode,cr.relation_type as relationType
        from main_building mr
        join mid_customer_building cr on cr.building_uuid=mr.building_uuid
        join main_customer mc on mc.id=cr.id
        join main_grid mg on mg.project_code=mr.belongto_projectcode
        where mr.belongto_projectcode=#belongToProjectCode#
        {? and mg.grid_uuid=#gridUuid#}
	]]>
    </entry>

    <!-- 根据客户名字、手机号码、固定电话、身份证号码查询房屋信息-->
    <entry key="sql-query-HomeOrPakringspace">
        <![CDATA[
		SELECT mr.belongto_building as building,
		       mr.belongto_unit + '' as unit,
		       mr.belongto_projectname as projectName,
		       mc.name as name,
		       mc.main_mobilenumber as mobilephone,
		       mc.home_phonenumber as phone,
		       mc.card_number as idnumber
		
		FROM main_building as mr left join mid_customer_building as mcr
		     on mr.building_uuid = mcr.building_uuid AND mcr.deleted = 0 left join main_customer as mc
		     on mc.id = mcr.id AND mc.deleted = 0
		
		WHERE 
			mr.deleted = 0
			{? AND mr.belongto_projectname = #item#}
			{? AND mr.belongto_building = #building#}
			{? AND mr.belongto_unit = #unit#}
			{? AND mc.name = #username#}
			{? AND mc.main_mobilenumber = #mobliephone#}
			{? AND mc.home_phonenumber = #phone#}
			{? AND mc.card_number = #cardid#}
			{? AND mc.id in (
					SELECT mc.id as id
		    	    FROM main_customer as mc,
		    		     dim_cust_cars as dcc
		    		WHERE mc.id = dcc.id
		    		AND   dcc.status = '使用中'
		    	    AND   dcc.car_license_number = #licenseid#
		    	    )}
    ]]>
    </entry>


    <!-- 根据房屋名模糊查询 -->
    <entry key="sql-query-customergeneral-byroomname">
    <![CDATA[
		SELECT  mrd.address as address,
		        mc.name as ownerOrphone,
		        mr.building_name as name,
			'房屋' as type
		
		FROM    main_building as mr left join main_building_detail as mrd
		        on mr.building_uuid = mrd.building_uuid left join mid_customer_building as mcr
		        on mcr.building_uuid = mr.building_uuid AND mcr.deleted = 0 left join main_customer as mc
		        on mc.id = mcr.id AND mc.deleted = 0
		
		WHERE   mr.deleted = 0
		AND     mcr.relation_type = '业主'
		        {? AND mr.building_name like CONCAT(CONCAT('%',#name#),'%') ESCAPE '/'}
	]]>
    </entry>
    
	<!-- 获取网格管家信息，呼叫中心 -->
	<entry key="sql.query.grid.byhouseid">
	<![CDATA[
	SELECT a.code as houseCode,c.id,c.code,c.name,c.description,c.projectId,p.isOuter,c.managerId,c.managerName,a.deliverTime
	from main_house a
	inner join mid_project_house b on a.id = b.houseId
 	inner join main_project p on p.id = b.projectId 
	LEFT JOIN main_grid c on b.gridId = c.id
	where a.id=#houseId#
	GROUP BY  a.code
	LIMIT 1
	]]>
	</entry>
	
	<!-- 获取管家手机电话 -->
	<entry key="sql.query.grid.managerphone">
	<![CDATA[
	select  
	MOBILE_PHONE as phone 
	from sec_user where id = #id#
	LIMIT 1
		]]>
	</entry>

    <!-- 根据项目ID获取该项目下的房屋 -->
    <entry key="sql.query.house.getHousesByProjectId">
    <![CDATA[
        select mh.id,mh.name,mh.unit,mph.buildingId,mph.unitId,mph.projectId,mph.floor
        from main_house mh,mid_project_house mph
        where 1=1
        and IFNULL(mh.isdeleted, 0) = 0
        and mh.id=mph.houseId
        and mph.projectId=#projectId#
        and mh.name like CONCAT(CONCAT('%',#houseName#),'%') ESCAPE '/'
        {? and mph.gridId=#gridId# }
    ]]>
    </entry>
    
    <!-- 查询房屋名称是否已经存在 -->
    <entry key="sql.query.housename">
    <![CDATA[
      select count(1) from main_house where name = ? and isdeleted = 0
    ]]>
    </entry>
    
	<!-- 获取楼栋信息 -->
    <entry key="sql.query.getBuildingInfo">
    <![CDATA[
      SELECT 
		 ph.houseId,
		 Ph.projectId,
		 ph.buildingId,
		 ph.buildingCode,
		 ph.buildingName,
		 ph.unitId,
		 ph.unit,
		 ph.floor,
		 ph.number,
		 ph.gridId,
		 ph.gridModifier,
		 ph.gridModifierId,
		 ph.gridModifyTime,
		 p.code AS projectCode,
		 p.name AS projectName,
		 h.modifyTime,
		 h.isDeleted AS houseIsDeleted
		FROM
		  main_house h 
		  INNER JOIN mid_project_house ph ON h.id = ph.houseId
		  INNER JOIN main_project p ON p.id = ph.projectId AND IFNULL(p.isDeleted, 0) = 0 
		WHERE IFNULL(h.isDeleted, 0) = 0 
		AND (BIT_LENGTH(h.code)>0)
		{? AND p.id=#projectId# }
		{? AND p.code=#projectCode# }
		{? AND p.name like CONCAT(CONCAT('%',#projectName#),'%') ESCAPE '/' }
		{? AND ph.buildingId=#buildingId# }
		{? AND ph.buildingCode=#buildingCode# }
		{? AND ph.buildingName like CONCAT(CONCAT('%',#buildingName#),'%') ESCAPE '/' }
		{? AND h.modifyTime >=  #modifyTime# }
	    {? AND h.modifyTime <=  #timestamp# }
    ]]>
    </entry>

	<!-- 获取房屋信息 -->
    <entry key="sql.query.getHouse">
    <![CDATA[
      SELECT 
		  h.id,
		  h.code AS houseCode,
		  h.parentId,
		  h.name AS houseName,
		  h.name_formal,
		  h.assistCode,
		  h.projectId,
		  h.buildingCode,
		  h.buildingName,
		  h.buildingName_formal AS houseNameFormal,
		  h.unit,
		  h.floor,
		  h.roomNumber,
		  h.status,
		  h.equityType,
		  h.contactsId,
		  h.contactsName,
		  h.contactsMobile,
		  h.broadband,
		  h.checkInTime,
		  h.deliverTime,
		  h.hasSubroom,
		  h.isSubroom,
		  h.isVirtual,
		  h.isCombine,
		  h.isSecondhand,
		  h.modifier,
		  h.modifierId,
		  h.modifyTime,
		  h.isDeleted,
		  h.deleter,
		  h.deleterId,
		  hd.address,
		  hd.province,
		  hd.city,
		  hd.district,
		  hd.buildingNo,
		  hd.orientation,
		  hd.roomCount,
		  hd.hallCount,
		  hd.kitchenCount,
		  hd.toiletCount,
		  hd.areaOfPreSale,
		  hd.builtUpArea,
		  hd.actualConstructionArea,
		  hd.preSaleConstructionArea,
		  hd.propertyArea,
		  hd.measuredBasementArea,
		  hd.terraceArea,
		  hd.setArea,
		  hd.measuredPoolArea,
		  hd.gardenArea,
		  hd.basementArea,
		  hd.fieldMeasuredArea,
		  hd.poolArea,
		  hd.garageArea,
		  hd.salesUnitPrice,
		  hd.referenceServiceCharge,
		  hd.isSubsidiary,
		  hd.practicalUse,
		  hd.layout,
		  p.code AS projectCode,
		  p.name AS projectName
		FROM
		  main_house h 
		  INNER JOIN main_house_detail hd ON h.id = hd.id
		  LEFT JOIN mid_project_house ph ON h.id = ph.houseId
		  LEFT JOIN main_project p ON p.id = ph.projectId
		WHERE 1=1
		AND (BIT_LENGTH(h.code)>0)
		{? AND p.code=#projectCode# }
		{? AND h.code=#houseCode# }
		{? AND h.code in ($houseCodes$)}
		{? AND h.projectId=#projectId# }
		{? AND h.buildingCode=#buildingCode# }
		{? AND h.buildingName like CONCAT(CONCAT('%',#buildingName#),'%') ESCAPE '/' }
		{? AND h.modifyTime >=  #modifyTime# }
	    {? AND h.modifyTime <=  #timestamp# }
    ]]>
    </entry>


    <!-- 查询一个用户拥有的网格信息（id和名称） -->
    <entry key="sql.query.gridinfo">
        <![CDATA[
        select id,code,name,projectId from main_grid
        where 1=1
        {? AND managerId=#userId#}
        {? AND projectId=#projectId#}
    ]]>
    </entry>


</properties>