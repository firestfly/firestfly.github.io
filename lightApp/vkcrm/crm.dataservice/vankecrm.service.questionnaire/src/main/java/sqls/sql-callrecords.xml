<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>问卷调查答案存储</comment>


    <!-- 查询新增外呼电话Id -->
    <entry key="sql-query-callRecord-Id">
        <![CDATA[
			SELECT
				call_id AS callId
			FROM
				biz_callrecords
			WHERE
				call_no = #callNo#
			{? AND
				answer_id = #answerId#}
        ]]>
    </entry>

     <!-- 更新外呼记录 -->
    <entry key="sql-update-callRecord">
        <![CDATA[
			UPDATE
				biz_callrecords
			SET
				{? start_time = #startTime#,}
				{? end_time = #endTime#,}
				{? duration = #duration#,}
				{? get_through = #getThrough# ,}
				telephoneist_id = #telephonistId#
			WHERE
				call_id = #callId#
        ]]>
    </entry>

    <!-- 查询通话记录 -->
    <entry key="sql-query-callRecord">
        <![CDATA[
		SELECT
		  bc.id as 'callRecordId',
			bc.callId AS callId,
			bc.callTime AS callTime,
			bc.beginTime AS startTime,
			bc.endTime AS endTime,
			bc.duration AS duration,
			sec_to_time(bc.duration) AS durationTime,
			ba.questionnaire_id AS questionnaireId,
			bc.telephonist AS telephonist,
			CASE bc.hangup_byself WHEN '1' THEN '员工挂机' WHEN '0' THEN '客户挂机' WHEN NULL THEN '未知' ELSE '未知' END  AS hangUp,
			bc.telephonistId AS telephonistId,
			bc.hasCheck AS hasCheck,
			bc.callNumber AS callNumber,
			bc.recordId AS recordNo,
			(SELECT a.title FROM biz_questionnaire a WHERE a.questionnaire_id = ba.questionnaire_id LIMIT 1) AS title,
			mp.name AS projectName,
			mh.name AS houseName,
			ba.abnormal_content AS abnormalContent,
			ba.abnormal_code AS abnormalCode,
			dat.error_category AS errorCategory,
			ba.customer_id AS customerId,
			ba.answer_id AS answerId,
			CASE ba.completed  WHEN '1' THEN '是' ELSE '否' END AS completed,
			bc.source,
			ba.house_id AS houseId,
			ba.project_id AS projectId,
			mh.code AS houseCode,
			mp.code AS projectCode,
			mc.fullname AS customerName,
			mc.code AS customerCode,
			(SELECT GROUP_CONCAT(tr.taskNo SEPARATOR ';') FROM task_records AS tr WHERE tr.callrecordid = bc.id and tr.reportUserMobile = bc.callNumber )AS tasks
		FROM
			tel_call_records AS bc
			left join mid_answer_callrecords mac on bc.id = mac.callrecord_id
			left join biz_answer ba on ba.answer_id = mac.answer_id
			left join dim_anomalous_tags dat on dat.answer_id = ba.answer_id
			left join vankecrm_center.main_project mp on ba.project_id = mp.id
			left join vankecrm_center.main_house mh on ba.house_id = mh.id
			left join vankecrm_center.main_customer mc on ba.customer_id = mc.id
		WHERE 1 = 1 AND bc.source = 2
		{? AND (SELECT a.title FROM biz_questionnaire a WHERE a.questionnaire_id = ba.questionnaire_id LIMIT 1) LIKE CONCAT(CONCAT('%',#questionnaireName#),'%') ESCAPE '/' }
		{? AND ba.house_addr LIKE CONCAT(CONCAT('%',#houseName#),'%') ESCAPE '/' }
		{? AND ba.project_id = #projectId#}
		{? AND bc.callNumber LIKE CONCAT(CONCAT('%',#callNumber#),'%') ESCAPE '/'}
		{? AND bc.telephonist = #telephonist#}
		{? AND ba.abnormal_code = #abnormalCode#}
		{? AND bc.callTime >= #fromTime#}
		{? AND bc.callTime <= #toTime#}
		{? AND bc.duration >= #fromDuration#}
		{? AND bc.duration <= #toDuration#}
		{? AND bc.recordId = #tapeCode#}
		{? AND bc.id in (SELECT tr.callRecordId FROM task_records tr WHERE tr.taskNo = #taskCode#)}
		{? AND ba.abnormal_code = #answerAbnormal#}
		{? AND ba.answer_id in (SELECT answer_id FROM dim_anomalous_tags WHERE error_category = #anomalousErrorCategory#)}
		{? AND ifnull(ba.completed, 0) = #isComplete#}
		ORDER BY bc.callTime DESC
        ]]>
    </entry>


    <!-- 添加中间信息 -->
    <entry key="sql-insert-tel-callreason">
        <![CDATA[
            INSERT INTO `mid_tel_callreason`
            (`callRecordId`, `reasonId`, `creatorId`, `createTime`, `isDeleted`, `deletorId`, `deleteTime`)
            VALUES (#callRecordIds#, '68', #creatorIds#, now(), 0, NULL, NULL)
        ]]>
    </entry>

</properties>
