<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>Excel异步导入相关的sql</comment>

	<entry key="sql.schedule.projectrole.startrole">
	<![CDATA[
		-- 启用到期的项目
		update mid_organization_user t
		   set t. status = 1
		 where ifnull(t.startTime, date_format('2000-01-01', '%Y-%m-%d')) < now()
		   and DATE_ADD(ifnull(t.endTime, date_format('3000-01-01', '%Y-%m-%d')),
		                Interval 1 day) > now()
		   and t.isDeleted = 0
		   and t.status = 0
	]]>
	</entry>

	<entry key="sql.schedule.projectrole.endrole">
	<![CDATA[
		-- 删除过期项目权限
		update mid_organization_user t
		   set t. status = 0
		 where ifnull(t.startTime, date_format('2000-01-01', '%Y-%m-%d')) > now()
		    or DATE_ADD(ifnull(t.endTime, date_format('3000-01-01', '%Y-%m-%d')),
		                Interval 1 day) < now()
		   and t.isDeleted = 0
		   and t.status = 1
	]]>
	</entry>
	
	<entry key="sql.schedule.projectrole.queryParentRole">
	<![CDATA[
		-- 项目过期需要删除过期管理中心权限
		SELECT mcr.*
		  FROM mid_organization_user mcr -- 管理中心 和 公司权限
		 INNER JOIN tree_organization t1 -- 组织树上的项目
		    ON mcr.organizationId = t1.parentId
		   AND t1.levelType = 4 -- 项目
		   AND t1.isDeleted = 0
		 WHERE mcr.isDeleted = 0
		   AND mcr. STATUS = 1
		   AND NOT EXISTS
		 (SELECT 1
		          FROM mid_organization_user pr2, tree_organization pt2
		         WHERE pr2.organizationId = pt2.id
		           AND pt2.parentId = mcr.organizationId
		           AND pr2.userId = mcr.userId
		           AND pr2.isDeleted = 0
		           AND pr2. STATUS = 1)
	]]>
	</entry>
	
	<entry key="sql.schedule.projectrole.queryParentParentRole">
	<![CDATA[
	-- 项目过期需要删除过期管理中心上级权限
	SELECT mcr.*
	  FROM mid_organization_user mcr -- 管理中心上级，或上上级，上上上级
	 INNER JOIN tree_organization t1
	    ON mcr.organizationId = t1.parentId
	   AND t1.id in($ids$)
	 WHERE mcr.isDeleted = 0
	   AND mcr. STATUS = 1
	   AND NOT EXISTS
	 (SELECT 1
	          FROM mid_organization_user pr2, tree_organization pt2
	         WHERE pr2.organizationId = pt2.id
	           AND pt2.parentId = mcr.organizationId
	           AND pr2.userId = mcr.userId
	           AND pr2.isDeleted = 0
	           AND pr2. STATUS = 1)
	]]>
	</entry>
	
	
		
	<entry key="sql.schedule.projectrole.queryNewParentRole">
	<![CDATA[
	-- 项目启用也启用项目的管理中心
		SELECT p.parentId AS organizationId, p.userId
		  FROM (SELECT DISTINCT t.parentId, r.userId
		          FROM mid_organization_user r, tree_organization t
		         WHERE r.organizationId = t.id
		           AND r.isDeleted = 0
		           AND r. STATUS = 1
		           AND t.levelType = 4) p
		  LEFT JOIN mid_organization_user mc
		    ON mc.organizationId = p.parentId
		   AND mc.userId = p.userId
		   AND mc.isDeleted = 0
		   AND mc. STATUS = 1
		 WHERE mc.organizationId IS NULL
	]]>
	</entry>
	
			
	<entry key="sql.schedule.projectrole.queryNewParentParentRole">
	<![CDATA[
	-- 项目启用也启用项目的管理中心上级
		SELECT p.parentId AS organizationId, p.userId
		  FROM (SELECT DISTINCT t.parentId, r.userId
		          FROM mid_organization_user r, tree_organization t
		         WHERE r.organizationId = t.id
		           AND r.organizationId in($ids$)) p
		  LEFT JOIN mid_organization_user mc
		    ON mc.organizationId = p.parentId
		   AND mc.userId = p.userId
		   AND mc.isDeleted = 0
		   AND mc. STATUS = 1
		 WHERE mc.organizationId IS NULL
	]]>
	</entry>
	
	
	
	
	 
	
</properties>