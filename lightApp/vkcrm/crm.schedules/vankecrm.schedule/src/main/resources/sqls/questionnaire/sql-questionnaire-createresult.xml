<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>Excel异步导入相关的sql</comment>	
	
	<entry key="sql-sati-createresule-result1">
	<![CDATA[	-- 查询项目完成率信息
		select a.project_id,
		       a.grid_id,
		       ifnull(a.total,0) as total,
		       ifnull(c.count,0) as complete_total,
		       ifnull(s.count,0) as complete_today,
		       (ifnull(p.target_today,0) - ifnull(p.complete_today,0)) as leftYestoday
		  from (select h.project_id, h.grid_id,h.questionnaire_id, count(*) as total -- 统计房屋总数
		          from sati_extraction_house h
		         where h.questionnaire_id = ?
		         group by h.project_id, h.grid_id,h.questionnaire_id) a
		  left join (select project_id, grid_id, count(*) as count -- 计算已完成数量
		               from sati_extraction_completed
		              group by project_id, grid_id) c
		    on c.project_id = a.project_id
		   and ifnull(c.grid_id, '123') = ifnull(a.grid_id, 123)
		  left join (select project_id, grid_id, count(*) as count -- 计算强制抽取和预约数
		               from sati_result_subscribe
		              group by project_id, grid_id) s
		    on s.project_id = a.project_id
		   and ifnull(s.grid_id, '123') = ifnull(a.grid_id, 123)
		  left join sati_result_project p -- 计算昨天剩余量
		    on p.questionnaire_id = a.questionnaire_id
		   and p.project_id = a.project_id
		   and ifnull(p.grid_id, '123') = ifnull(a.grid_id, '123')
		   and p.record_date =
		       DATE_ADD(DATE_FORMAT(NOW(), '%Y-%m-%d'), Interval - 1 day)
	]]>
	</entry>
		
	<entry key="sql-sati-createresule-result2">
	<![CDATA[	-- 插入结果预约客户
		INSERT INTO sati_result_subscribe
		  (questionnaire_id,project_id,grid_id,house_id,customer_id,appointment_time,status)
		  SELECT questionnaire_id,project_id,grid_id,house_id,customer_id,appointment_time,0
		    FROM sati_extraction_subscribe
		   where questionnaire_id = ?
	]]>
	</entry>
	
	<entry key="sql-sati-createresule-result3">
	<![CDATA[	-- 插入结果客户
		INSERT INTO sati_result_customer
		  (questionnaire_id, project_id,grid_id, house_id, customer_id,status)
		  SELECT questionnaire_id, project_id,grid_id, house_id, customer_id, 0
		    FROM sati_extraction_customer where questionnaire_id = ?
	]]>
	</entry>
	
	<entry key="sql-sati-extractionCustomer-select-subscribe1">
	<![CDATA[ -- 当强制抽取客户大于当天目标时，删除多余强制抽取客户
		SELECT p.PROJECT_ID,ifnull(p.grid_id,'123') as GRID_ID,rs.count - p.target_today as COUNT
		  FROM sati_result_project p,
		       (SELECT s.project_id,s.grid_id, s.questionnaire_id, count(*) AS count
		          FROM sati_result_subscribe s
		         where s.questionnaire_id = ?
		         GROUP BY s.project_id,s.grid_id) rs
		 WHERE p.project_id = rs.project_id
		   and ifnull(p.grid_id,'123') = ifnull(rs.grid_id,'123')
		   and p.questionnaire_id = rs.questionnaire_id
		   AND rs.count > p.target_today
		   and p.questionnaire_id = ?
	]]>
	</entry>
	
	<entry key="sql-sati-extractionCustomer-delete-subscribe2">
	<![CDATA[
		-- 当强制抽取客户大于当天目标时，删除多余强制抽取客户
		DELETE FROM sati_result_subscribe
		 WHERE appointment_time is null
		   and  questionnaire_id = ?
		   and project_id = ? and ifnull(grid_id,'123') = ? LIMIT ?
	]]>
	</entry>

	
</properties>