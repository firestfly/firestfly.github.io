function ModalEditTask(a){ModalEditTask.DataMerge(),ModalEditTask.BindEvent()}function EditVerify(a,b){var c=$("#"+a),d=c.find("input").val();if(c.find(".info-div>i").remove(),"notext"==b)""==d?c.find(".info-div").append("<i class='error'>不能为空</i>"):c.find(".info-div").append("<i class='OK'>√</i>");else if("IDNumber"==b){var e=validateIdcard(d);e.isError?c.find(".info-div").append("<i>身份证号输入有误</i>"):c.find(".info-div").append("<i class='OK'>√</i>")}}function validateIdcard(a){var b=a;if(""==b)return{isError:!1};var c={11:"北京",12:"天津",13:"河北",14:"山西",15:"内蒙古",21:"辽宁",22:"吉林",23:"黑龙江 ",31:"上海",32:"江苏",33:"浙江",34:"安徽",35:"福建",36:"江西",37:"山东",41:"河南",42:"湖北 ",43:"湖南",44:"广东",45:"广西",46:"海南",50:"重庆",51:"四川",52:"贵州",53:"云南",54:"西藏 ",61:"陕西",62:"甘肃",63:"青海",64:"宁夏",65:"新疆",71:"台湾",81:"香港",82:"澳门",91:"国外 "},d="",e=!0;if(b&&/^[1-9][0-9]{5}(19[0-9]{2}|200[0-9]|2010)(0[1-9]|1[0-2])(0[1-9]|[12][0-9]|3[01])[0-9]{3}[0-9xX]$/i.test(b))if(c[b.substr(0,2)]){if(18==b.length){b=b.split("");for(var f=[7,9,10,5,8,4,2,1,6,3,7,9,10,5,8,4,2],g=[1,0,"X",9,8,7,6,5,4,3,2],h=0,i=0,j=0,k=0;17>k;k++)i=b[k],j=f[k],h+=i*j;g[h%11];g[h%11]!=b[17]&&(d="校验位错误",e=!1)}}else d="地址编码错误",e=!1;else d="身份证号格式错误",e=!1;return{isError:!e,errorInfo:d}}window.Page_taskList={};var dicData=[];jQuery(document).ready(function(){$("#WorkbenchTab li").on("click",function(){var a=$("#WorkbenchTab li").index(this);$("#WorkbenchTab").find(".active").removeClass("active"),$(this).addClass("active"),$(".ly-panel.on").removeClass("on"),$(".ly-panel").eq(a).addClass("on")})}),window.Page_taskList.taskList=function(){function a(a){M&&M.abort(),M=Common.ajax({url:J.url_getTaskdictionaryCode,type:"POST",data:{codes:F},success:function(a){a.success&&(dicData=a.details,$("#steward-search-from").html(template("SearchFromTemplate",dicData)),$("#steward-search-operator").html(template("SearchOperatorTemplate",dicData)))},error:function(){},complete:function(){}})}function b(a,b,c){var d=a||C,e=b||D,g=c||E,h=servicePath.customer+"/v1/customers/pending/"+d+"/"+e;K&&K.abort(),C=d,D=e,E=g,K=Common.ajax({url:h,type:"get",data:g,success:function(a){if(a.success){var b=a.details,c=b.pagination;b.list.length;window.pendingTaskListData=b.list,f(b),R.render({curpage:c.curPage,pagesize:c.pageSize,totalpage:c.totalPage,totalsize:c.totalSize})}},error:function(){},complete:function(){}}),Common.loading({text:"",container:"#customerTable",handle:K})}function c(a,b,c){var d=servicePath.customer+"/v1/customers/pending/approved/"+a+"/"+b;L&&L.abort(),L=Common.ajax({url:d,type:"get",data:c,success:function(a){if(a.success){var b=a.details,c=b.pagination;b.list.length;b.stata="已办",f(b),R.render({curpage:c.curPage,pagesize:c.pageSize,totalpage:c.totalPage,totalsize:c.totalSize})}},error:function(){},complete:function(){}}),Common.loading({text:"",container:"#customerTable",handle:L})}function d(a,b){N&&N.abort(),N=Common.ajax({url:servicePath.customer+"/v1/customer/"+b+"/info",type:"get",data:a,success:function(a){a.success&&(ModalEditTask.params.basedata=a,ModalEditTask())},error:function(){},complete:function(){}}),Common.loading({text:"",container:".modal_wrap",handle:N})}function e(a,b){O&&O.abort(),O=Common.ajax({url:servicePath.customer+"/v1/customer/"+b+"/pending",type:"get",data:a,success:function(a){a.success&&(ModalEditTask.params.pendingdata=a.details)},error:function(){},complete:function(){}})}function f(a){var b=t(a);u.html(b)}function g(){var a,b;z.typeahead({items:10,source:function(c,d){a&&a.abort();z.val();a=Common.ajax({url:window.servicePath.house+"/v1/organization/house",type:"get",data:{projectId:B.val(),houseName:z.val()},success:function(a){var c=[];if(a&&a.details){b=a.details;for(var e=0;e<b.length;e++)c.push(b[e].id)}else b=[];d(c)}})},matcher:function(){return!0},highlighter:function(a){for(var c,d=0;d<b.length;d++)if(b[d].id==a)return c=b[d],c.name},updater:function(a){for(var c,d=0;d<b.length;d++)if(b[d].id==a)return c=b[d],x.val(c.id),c.name}})}function h(a){for(var b=a.details||[],c="",d=0;d<b.length;d++){var e=b[d];c+='<option value="'+e.id+'">'+e.name+"</option>"}B.html(c).removeAttr("disabled")}function i(a,c){Common.ajax({url:window.servicePath.customer+"/v1/customer/approveStatus",type:"POST",data:{customerId:a},success:function(a){b()},error:function(){c.addClass("j_abandon")},complete:function(){c=null}})}function j(){B.attr("disabled",!0).html("<option>==正在加载项目==</option>"),Common.ajax({url:window.servicePath.house+"/v1/organization/project",type:"get",success:function(a){h(a)},complete:function(){}})}function k(a,b,c,d){B.val(c),z.val(b).attr("disabled",!0),x.val(a),y.val(d),w.modal("show")}function l(a,b,c,f){ModalEditTask.params.houseName=b,s.modal("show"),d({houseId:a},f),e({houseId:a},c)}function m(a){z.val(""),x.val(""),a?z.removeAttr("disabled"):z.attr("disabled",!0)}function n(){var a=$(window).height()-340;u.height(a>0?a:0)}function o(){$("#task_searchBtn").on("click",function(){var a=$("#steward-search-startTime").val(),b=$("#steward-search-endTime").val(),c=$("#steward-search-from option:selected").attr("data-code"),d=$("#steward-search-operator option:selected").attr("data-code");u.html(""),P[Q](1,10,{startTime:a,endTime:b,from:c,operator:d})}),v.on("click",function(){var a=$(this),b=a.attr("id");v.removeClass("active"),a.addClass("active"),"nopass-list"==b?Q="getPendingTaksListPage":"pass-list"==b&&(Q="getProcessedTaksListPage"),u.html(""),P[Q](G,H)}),u.on("click",".j_handle",function(){var a=$(this).attr("data-houseid"),b=$(this).attr("data-customerid");a=""==a?null:a,b=""==b?null:b;var c;if(window.pendingTaskListData){for(var d=0;d<window.pendingTaskListData.length;d++)if(console.log(window.pendingTaskListData[d].customerId+" - "+window.pendingTaskListData[d].houseId),window.pendingTaskListData[d].customerId==b&&window.pendingTaskListData[d].houseId==a){c=window.pendingTaskListData[d];break}var e=JSON.stringify(c);window.onePendingTaskData=escape(e)}var f=$(this),g=f.attr("data-crmCustomerId"),h=f.attr("data-customerId"),i=f.attr("data-houseId"),j=f.attr("data-projectId"),m=f.parent().parent().find(".houseName").text();g?l(i,m,h,g):k(i,m,j,h)}),u.on("click",".j_abandon",function(){var a=$(this),b=a.attr("data-customerId");b&&window.confirm("确定放弃？")&&(a.removeClass("j_abandon"),i(b,a))}),g(),B.on("change",function(){m(this.value)}),$("#housechoose_houseclick").on("click",function(){void 0==z.attr("disabled")&&z.focus().typeahead("show")}),$("#housechoose_ok").on("click",function(){var a=x.val(),b=y.val(),c="";return a?(c=path.server+"/page/house/"+a+"/customer",b?(c+="?pendingId="+b,c+="&customerInfo="+window.onePendingTaskData):c+="?customerInfo="+window.onePendingTaskData,location.href=c):alert("请确认房屋信息"),!1}),$(window).on("resize",n),n()}function p(){v=$("#manage-tab li"),u=$("#customerTable"),s=$("#modal_edittask"),w=$("#modal_housechoose"),x=$("#housechoose_houseId"),y=$("#housechoose_customerId"),z=$("#housechoose_houseName"),A=$("#housechoose_organization"),B=$("#housechoose_project"),t=template.compile($(J.taskListTemplate).html()),j()}function q(a){}function r(c){I||(I=!0,p(),o()),q(c),a(),b(1,10)}var s,t,u,v,w,x,y,z,A,B,C,D,E,F="approveStatus4Tmp,operator,from,CustomerRelationType,HouseCustomerRelationType,Sex,CustomerCertificateType#CRMv2,CustomerTags,CustomerHobbies",G=1,H=10,I=!1,J={url_getTaskdictionaryCode:servicePath.customer+"/v1/dict/items",taskListTemplate:"#taskListTemplate"},K=null,L=null,M=null,N=null,O=null,P={getPendingTaksListPage:b,getProcessedTaksListPage:c},Q="getPendingTaksListPage",R=new Pagination({template:"#paginationtmpl",selector:"#TasksListPagination",onchange:function(a){G=a.curpage,H=a.pagesize,P[Q](G,H)}});return r(),{init:r,getPendingTaksList:b}}(),ModalEditTask.params={basedata:[],pendingdata:[],mergedata:{}},ModalEditTask.BindEvent=function(){ModalEditTask.BindEvent.hasInit||(ModalEditTask.BindEvent.hasInit=!0,$("#modal_edittask").on("click",".btn-editinfo",function(){var a,b=$(this);b.hasClass("edit")?(a=$(".btn-editinfo.edit").index(this),b.removeClass("editstate"),b.next(".cencel").show(),ModalEditTask.EditTo(a)):(a=$(".btn-editinfo.cencel").index(this),b.hide(),b.prev(".edit").addClass("editstate"),ModalEditTask.CencelEditTo(a))}),$("#Edit_OK").on("click",function(){if("0"==$("#ModalEditTaskBar").find(".error").length){if(!window.confirm("确定要审核通过该客户信息吗？"))return;var a=$("#base_name").attr("data-id")||"",b=$("#pending_name").attr("data-id")||"",c=$("#task_housename").attr("data-id")||"",d=$("#base_name input").val(),e=$("#base_sex").attr("data-code")||"",f=$("#base_mainMobile input").val(),g=$("#base_standbyMobile input").val(),h=$("#base_homeTel input").val(),i=$("#base_officeTel input").val(),j=$("#base_certificateType").attr("data-code")||"",k=$("#base_certificateId input").val(),l=$("#base_hobbies").attr("data-code")||"";","==l.charAt(l.length-1)&&(l=l.substring(0,l.length-1)),ModalEditTask.CustomerDataPost({cardNo:k,cardType:j,customerId:b,crmCustomerId:a,hobbyIds:l,houseId:c,mainMobile:f,standbyMobile:g,homeTel:h,officeTel:i,name:d,sex:e},b)}else alert("请填写正确信息！")}),$("#Edit_GiveUp").on("click",function(){var a=$("#task_housename").attr("data-pendingId");ModalEditTask.GiveUpEditPost({pendingId:a})}),$("#ModalEditTaskBar").on("click",".btn_exchange",function(){var a=$(this).parent().prev().find("div"),b=$(this).parent().next().find("div"),c=$("<div></div>"),d=$("<div></div>");c.insertBefore(a),d.insertBefore(b),a.insertAfter(d),b.insertAfter(c),c.remove(),d.remove()}))},ModalEditTask.DataMerge=function(){var a=ModalEditTask.params.basedata.details,b=ModalEditTask.params.pendingdata,c=ModalEditTask.params.mergedata;c.basedata=[],c.pendingdata=[],c.basedata=a,c.pendingdata=b;for(var d=c.basedata.hobby.length,e=c.pendingdata.hobby.length,f=c.basedata.houseRelation.length,g=c.pendingdata.houseRelation.length,h=[],i="",j=[],k="",l=[],m="",n=[],o="",p=0;d>p;p++)h.push(c.basedata.hobby[p].contentText);for(var p=0;e>p;p++)j.push(c.pendingdata.hobby[p].contentText);for(var p=0;f>p;p++)l.push(c.basedata.houseRelation[p].relationType);for(var p=0;g>p;p++)n.push(c.pendingdata.houseRelation[p].relationType);i=h.join(","),k=j.join(","),m=l.join(","),o=n.join(","),c.basedata.hobbyTo=i,c.pendingdata.hobbyTo=k,c.basedata.houseRelationTo=m,c.pendingdata.houseRelationTo=o,c.hasEditPermission=window.hasEditPermission||!1;var q=template("ModalEditTaskTemplate",c);$("#ModalEditTaskBar").html(q)},ModalEditTask.EditTo=function(a){var b=$(".edit-info").eq(a),c=b.attr("data-type"),d=b.attr("edit-type");if("inputedit"!=c&&ModalEditTask.CheckBoxDataGet(c),"text"==d)b.find(".tempdata .info-div,.task_info_exchange").hide(),b.find(".info-input").removeClass("info-input-unedit").removeAttr("disabled");else if("check"==d){var e="",f="",g=[],h=[];b.addClass("noborder"),b.find(".tempdata>.info-div,.task_info_exchange").hide(),b.find(".info_checkbar").show(),b.on("click","input",function(){if("radio"==$(this).attr("type"))e=$(this).parent().text();else if("checkbox"==$(this).attr("type")){var a=$(this);$(this).prop("checked")?(g.push($(this).val()),h.push($(this).attr("data-code"))):($.each(g,function(b,c){g[b]=a.val()==c?"":c}),$.each(h,function(b,c){h[b]=a.attr("data-code")==c?"":c})),e=$.grep(g,function(a){return $.trim(a).length>0}).join("，"),f=$.grep(h,function(a){return $.trim(a).length>0}).join(",")}b.find(".basedata>.info-div").text(e),b.find(".basedata").attr("data-code",f)})}},ModalEditTask.CencelEditTo=function(a){var b=$(".edit-info").eq(a),c=b.attr("edit-type"),d=b.find(".basedata").attr("data-text"),e=b.find(".tempdata").attr("data-text");b.find(".info-div>i").remove(),"text"==c?(b.find(".tempdata>.info-div,.task_info_exchange").show(),b.find(".info-input").addClass("info-input-unedit").attr("disabled","true"),b.find(".basedata .info-input").val(d),b.find(".tempdata .info-input").val(e)):"check"==c&&(b.removeClass("noborder"),b.find(".tempdata>.info-div,.task_info_exchange").show(),b.find(".info_checkbar").hide(),b.find(".basedata .info-div").text(d),b.find(".tempdata .info-div").text(e))},ModalEditTask.CheckBoxDataGet=function(a){var b;"Sex"==a?(b=template("EditSexTemplate",dicData),$("#SexBar").html(b)):"certificateType"==a?(b=template("EditcertificateTypeTemplate",dicData),$("#certificateTypeBar").html(b)):"CustomerHobbies"==a?(b=template("CustomerHobbiesBarTemplate",dicData),$("#CustomerHobbiesBar").html(b)):"CustomerRelationType"==a?(b=template("EditCustomerRelationTypeTemplate",dicData),$("#CustomerRelationBar").html(b)):"HouseCustomerRelationType"==a&&(b=template("EditHouseCustomerRelationTypeTemplate",dicData),$("#HouseCustomerRelationBar").html(b))},ModalEditTask.CustomerDataPost=function(a,b){var c=null;c&&c.abort(),c=Common.ajax({url:window.servicePath.customer+"/v1/customer/"+b,type:"post",data:a,success:function(a){a.success?(window.Page_taskList.taskList.getPendingTaksList(1,10),alert("修改成功")):alert(a.message)},error:function(a){alert("保存失败："+a.message)},complete:function(){}})},ModalEditTask.GiveUpEditPost=function(a){var b=null;b&&b.abort(),b=Common.ajax({url:servicePath.customer+"/v1/customers/pending/cancel",type:"GET",data:a,success:function(a){a.success?(alert("任务已放弃"),$("#modal_edittask").modal("hide"),window.Page_taskList.taskList.getPendingTaksList(1,10)):alert(a.message)},error:function(a){alert("任务放弃失败："+a.message)},complete:function(){}})};