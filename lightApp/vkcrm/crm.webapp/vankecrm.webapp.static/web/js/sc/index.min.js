function breadTemp(a){if(a){for(var b=[],c="",d=a.length-1;d<a.length;d++)c="<span title='"+a[d].text+"'>当前位置："+a[d].text+"</span>",b.push(c);return b.join(" / ")}}function ExportRoom(){Common.loadingNeedUnload({text:"下载中...",container:".panel-body"}),setTimeout("Common.unLoading()",5e3);var a=path.server+"/page/roomsExport/export";document.getElementById("downloadFileFrameID2").src=a}window.Page_index={},window.editstate=!1,function(a,b){function c(a,b,c,d,f){var g=a.hasChild,h=a.name+(a.levelType==s.keys.unit?"单元":""),i=a.id,j=a.levelType,k=a.outer,l=d==i,m=a.open,n="";return k&&(h+="(外)"),n+='<li class="'+(m?s.css.show:s.css.loading)+(l?" on":"")+'"',n+=' data-id="'+i+'"',n+=' data-index="'+b+'"',n+=' data-haschild="'+(g?1:0)+'"',n+=' data-leveltype="'+j+'"',n+=">",n+='<div class="'+(g?s.css.brank:"")+'">',n+='<span  style="padding-left:'+c+'px;">'+h,g&&(n+='<i class="refresh"></i>'),n+="</span></div>",m&&f&&f.length&&(n+=e(f,b+1,d)),n}function d(a,b){for(var d=[],e="<ul>",f=s.basePaddingLeft+(b-1)*s.paddingLeft,g=0;g<a.length;g++){var h=a[g],i=c(h,b,f,null,null);d.push(i)}return e+d.join("")+"</ul>"}function e(a,b,d){var e=a[0],f=[],g="<ul>",h=s.basePaddingLeft+(b-1)*s.paddingLeft;a=a.slice(1);for(var i="",j=0;j<e.length;j++){var k=e[j];i=c(k,b,h,d,a),f.push(i)}return g+f.join("")+"</ul>"}function f(b,c){var f=parseInt(b.attr("data-index"))+1||1,g=c||b.attr("data-id"),h=(b.attr("data-haschild"),b.attr("data-leveltype"));t&&t.abort(),t=Common.ajax({url:c?s.url_getReverseTree:s.url_getTreeData,type:"get",data:{treeNodeId:g,levelType:h},success:function(h){if(h.success){var i="";if(c){var j=g.split(",").pop();i=e(h.details,f,j)}else i=d(h.details,f);b.find("ul").remove(),b.append(i),b.removeClass(s.css.loading),a("#vankeTree>ul>li>div").addClass("first-tree-brank"),a("#vankeTree>ul>li").first().children("ul").addClass("firstul")}},error:function(){},complete:function(){}})}function g(a){var b=a.attr("data-id"),c=a.attr("data-leveltype");c==s.keys.parking;var d=a.parent().parent();return d.get&&"LI"==d.get(0).nodeName?g(d)+","+b:b}function h(a){a.siblings().removeClass(s.css.show),a.addClass(s.css.show)}function i(a){a.removeClass(s.css.show)}function j(a){var b=a.attr("data-leveltype"),c=a.attr("data-id"),d={projectId:void 0,buildingId:void 0,unitId:void 0};if(b===s.keys.unit){var e=a.parent().parent(),f=e.parent().parent(),g=e.attr("data-id"),h=f.attr("data-id");d.unitId=c,d.buildingId=g,d.projectId=h}if(b===s.keys.floor){var f=a.parent().parent(),h=f.attr("data-id");d.buildingId=c,d.projectId=h}if(b===s.keys.parking){var f=a.parent().parent(),h=f.attr("data-id");d.projectId=h,d.carparkId=c}return d}function k(a,b){var c=b||[],d={},e=a.parent().parent();return d.text=a.children(":first").text(),c.unshift(d),"LI"==e.prop("nodeName")&&k(e,c),c}function l(){r.on("click","li",function(){var b=a(this),c="1"==b.attr("data-haschild"),d=b.attr("data-leveltype"),e=b.attr("data-id"),l=b.hasClass(s.css.show),m=b.hasClass(s.css.loading),n=b.text();if("3"==d||"8"==d?(p(e),o(d,n)):"4"==d&&o(d,n),a("#buildingPanel").css("top","42px"),a("#house-combine-btn").hide(),c)l?i(b):m?(h(b),f(b)):h(b);else{var q=j(b),t=k(b);window.editstate=!1,a("#house-combine-btn").hide(),a("#buildingList").find(".floor-room").removeClass("active"),s.keys.floor==d||s.keys.unit==d?Page_index.floor.init(q,t):s.keys.parking==d&&Page_index.parking.init(q,t);var u=g(b);s.keys.floor==d&&(u+=",");var v={};v.treeids=u,v.leveltype=d,Common.hash.set(v),r.find("li").removeClass("on"),b.addClass("on")}return!1}),r.on("click",".refresh",function(){var b=a(this),c=b.parent().parent().parent();return f(c),!1}),a("#sel_mc").bind("change",function(){var b=a("#sel_mc").val();p(b)}),a("#sel_prj").bind("change",function(){a("#houseName").val(""),a("#houseId").val(""),a("#unitId").val(""),a("#floor").val(""),a("#buildingId").val(""),a("#search_projectId").val("")})}function m(c){r=a(b),l(),q(),n(),f(r,c)}function n(){Common.ajax({url:s.url_getMCOptions,type:"get",data:{},success:function(b){if(b.success){for(var c=b.details,d=0;d<c.length;d++)a("#sel_mc").append("<option value='"+c[d].id+"'>"+c[d].name+"</option>");var e=a("#sel_mc").val();p(e)}},error:function(){},complete:function(){}})}function o(b,c){var d=a(b?"#sel_mc":"#sel_prj");d.val(c)}function p(b){a("#sel_prj").empty(),Common.ajax({url:s.url_getPJOptions,type:"get",data:{levelType:4,parentId:b},success:function(b){if(b.success)for(var c=b.details,d=0;d<c.length;d++)a("#sel_prj").append("<option value='"+c[d].id+"'>"+c[d].name+"</option>")},error:function(){},complete:function(){}})}function q(){a("#houseName").typeahead({items:30,source:function(b,c){u&&u.abort();var d=a("#houseName").val(),e=a("#sel_prj").val();u=Common.ajax({url:s.url_getHouse,type:"get",data:{projectId:e,houseName:d},success:function(a){products=a.details;for(var b=[],d=0;d<products.length;d++)b.push(products[d].id);c(b)}})},matcher:function(a){return!0},highlighter:function(a){for(var b,c=0;c<products.length;c++)if(products[c].id==a)return b=products[c],b.name+"("+b.unit+")"},updater:function(b){for(var c,d=0;d<products.length;d++)if(products[d].id==b)return a("#houseId").val(b),a("#unitId").val(products[d].unitId),a("#floor").val(products[d].floor),a("#buildingId").val(products[d].buildingId),a("#search_projectId").val(products[d].projectId),a("#houseName").val(products[d].name),c=products[d],c.name}}),a("#search_house").click(function(){var b=a("#search_projectId").val(),c=a("#unitId").val(),d=a("#floor").val(),e=a("#buildingId").val(),f={projectId:b,unitId:c,floorIndex:d,buildingId:e,curPage:1},g=1;Page_index.floor.init(f),Page_index.floor.getRooms(f,g)})}var r,s={url_getTreeData:servicePath.house+"/v1/organization/tree",url_getOptions:servicePath.house+"/v1/organization/items",url_getMCOptions:servicePath.house+"/v1/organization/McAndCompany",url_getPJOptions:servicePath.house+"/v1/organization/project",url_getHouse:servicePath.house+"/v1/house/queryByProjectId",url_getReverseTree:servicePath.house+"/v1/organization/reverseTree",label:{treeids:"treeids",treetype:"treetype"},keys:{floor:"5",unit:"6",parking:"9"},css:{show:"vkt-active",loading:"vkt-loading",brank:"vk-tree-brank",leaf:"listbar-li"},basePaddingLeft:10,paddingLeft:14},t=null,u=null;Page_index.tree={init:m}}(jQuery,"#vankeTree"),function(a,b){function c(b,c){var d=a(c),e=d.attr("href"),g=d.attr("query"),h=e+"_more",i=a(h),j=i.attr("data-groupid"),k=i.attr("data-curpage");k&&"true"!=g||("true"==g&&d.attr("query","false"),f({projectId:q,carparkId:r,groupId:j,curPage:k||1},h))}function d(a){var b="";b=D.url_getGroups.replace("{:projectId}",a.projectId).replace("{:carparkId}",a.carparkId),E&&E.abort(),E=Common.ajax({url:b,type:"get",success:function(a){a.success&&g(a.details)},error:function(){},complete:function(){}})}function e(a){if(a){var b=path.server+"/page/carport/"+a+"/details";window.location.href=b}}function f(b,c){var d="";b.groupId?(d=D.url_getGroupCarports.replace("{:projectId}",b.projectId).replace("{:carparkId}",b.carparkId).replace("{:id}",b.groupId),delete b.projectId):(d=D.url_getUngroupCarports.replace("{:projectId}",b.projectId).replace("{:carparkId}",b.carparkId),delete b.groupId);var e=a(c);e.addClass("park-loading"),Common.ajax({url:d,type:"get",data:{curPage:b.curPage,carportName:a("#carportName").val()||""},success:function(a){if(a.success){var d=a.details,f=0==d.pagination.totalPage||d.pagination.curPage==d.pagination.totalPage;h(d,c,f),e.attr("data-curpage",b.curPage)}e.removeClass("park-loading")},error:function(){e.removeClass("park-loading")},complete:function(){}})}function g(a){for(var b="",c="",d="",e=0;e<a.length;e++){var f=a[e],g="parkinggroup_"+e,h=g+"_more";b+='<li><a href="#'+g+'" query="false" data-groupid="'+f.id+'">'+("UNGROUP"==f.name?"选择分组":f.name)+"</a></li>",d+='<div class="park-wrap" id="'+g+'"><div class="park park-more" id="'+h+'" data-groupid="'+f.id+'"></div></div>',c+='<option value="'+f.id+'">'+("UNGROUP"==f.name?"选择分组":f.name)+"</option>"}u.html(b),y.html(d),v.html(c),C.fire(0)}function h(b,c,d){var e=A(b);jq_more=a(c),jq_more.before(e),d?jq_more.hide():jq_more.show()}function i(){t=a(b),u=a("#parkingNav"),v=a("#parkingSelect"),w=a("#parkingGroupOk"),x=a("#parkingGroupCancel"),z=a("#parkBreadcrumb"),y=a("#parkingPanels"),A=template.compile(a(D.parkingTempId).html())}function j(){t.addClass("on").siblings().removeClass("on")}function k(){var b=[],c=v.val();return c?(y.children(".active").find(".park.on").each(function(c,d){var e=a(this);b.push(e.attr("data-id"))}),void Common.ajax({url:D.url_submitGroup,type:"put",data:{carportIds:b.join(","),groupId:c},success:function(a){a.success&&(alert("分组成功"),C.fire(0))},error:function(){},complete:function(){}})):void alert("请选择分组")}function l(){C=Common.navigation("#parkingNav",c),a(".j_btnSetGroup",t).on("click",function(){a(".dtn-team").toggleClass("dtn-team-block"),B=!B}),t.on("click",".park",function(){B&&a(this).toggleClass("on")}),t.on("click",".park-more",function(){var b=a(this),c="#"+b.attr("id"),d=b.attr("data-groupid"),e=b.attr("data-curpage");e&&(e++,f({projectId:q,carparkId:r,groupId:d,curPage:e},c))}),a("#parkingGroupOk",t).on("click",function(){k()}),a("#parkingGroupCancel",t).on("click",function(){t.removeClass(D.css_editModal)});var b;a("#modal_carportDetail");y.on("click",".park-name",function(){b=a(this).parent().attr("data-id"),e(b)}),a("#carportName").change(function(){a("#parkingNav").find("a[query]").attr("query","true"),a("#parkingPanels div.park[data-id]").remove();var b=a("#parkingNav li.active a"),d=b.attr("href"),e=d+"_more",f=a(e);f.attr("data-curpage",""),c(null,a("#parkingNav li.active a"))}),a("#search_carport").click(function(){var b="";b=D.url_getFoundGroup.replace("{:projectId}",q).replace("{:carparkId}",r),F&&F.abort(),F=Common.ajax({url:b,type:"get",data:{carportName:a.trim(a("#carportName").val())||""},success:function(b){b.success&&a("#parkingNav").find('a[data-groupid="'+b.details+'"]').trigger("click")},error:function(){},complete:function(){}})});var d=a("#modal_carportDetail");d.on("click","#modal_tansfercustomer_btn",function(){a("#carport_customers").addClass("editmode"),a("#ownerName").removeClass("hidden").show();var b,c=null;a("#modal_tansfercustomer_btn").toggleClass("hidden"),a("#oldownerName").toggleClass("hidden"),a("#modal_transfercarport_btn").toggleClass("hidden"),a("#modal_transfercarport_btn").bind("click",function(){var b=a("#carportId").val(),c=a("#carport_customers").find("span.word").map(function(){return a(this).attr("data-id")});return c=Array.prototype.join.call(c,","),null==c||""==c?void a("#div_ownerName").addClass("error"):void Common.ajax({url:servicePath.house+"/v1/carport/carportInfo/"+b+"/carportTransfer",type:"post",data:{newIds:c},success:function(){m(b)}})}),a("#ownerName").typeahead({source:function(d,e){c&&c.abort();var f=a("#ownerName").val(),g=a("#projectId").val();c=Common.ajax({url:Config.customerPath+"/v1/customer/queryCustomer4CarportTransfer/"+g,type:"get",data:{name:f},success:function(a){b=a.details;for(var c=[],d=0;d<b.length;d++)c.push(b[d].id);e(c)}})},matcher:function(a){return!0},highlighter:function(a){for(var c,d=0;d<b.length;d++)if(b[d].id==a)return c=b[d],"姓名:"+c.fullName+"   证件号码:"+c.certificateId},updater:function(c){for(var d,e=0;e<b.length;e++)if(b[e].id==c)return a("#newOwnerId").val(c),a("#ownerName").val(b[e].fullName),d=b[e],a("#carport_customers").append("<span class='word' data-id='"+d.id+"'><span>"+d.fullName+"</span><span>"+d.mainMobile+"</span><i>X</i></span>"),d.fullName}})})}function m(b){var c=servicePath.house+"/v1/carport/carportInfo/"+b;Common.ajax({url:c,type:"get",success:function(b){var c=template("carportDetail",b.details),d=b.details.customerInfos;a("#modal_carportDetail").html(c),n(d),a("#carport_customers").on("click","i",function(){a(this).parent().remove()})},error:function(){},complete:function(){}})}function n(b){for(var c=0;c<b.length;c++)a("#carport_customers").append("<span class='word' data-id='"+b[c].customerId+"'><span>"+b[c].owner+"</span><span>"+b[c].mainMobile+"</span><i>X</i></span>")}function o(a,b){s||(s=!0,i(),l()),p(a,b),j()}function p(a,b){q=a.projectId,r=a.carparkId,u.empty(),v.empty(),y.empty(),z.html(breadTemp(b)),d({projectId:q,carparkId:r})}var q,r,s=!1,t=null,u=null,v=null,w=null,x=null,y=null,z=null,A=null,B=!1,C=null,D={url_getGroups:servicePath.house+"/v1/carport/groups/{:projectId}/{:carparkId}",url_getGroupCarports:servicePath.house+"/v1/carport/group/{:projectId}/{:carparkId}/{:id}",url_getUngroupCarports:servicePath.house+"/v1/carport/{:projectId}/{:carparkId}/ungroup",url_getFoundGroup:servicePath.house+"/v1/carport/querygroup/{:projectId}/{:carparkId}",css_editModal:"edit-modal",parkingTempId:"#indexParkTemp"},E=null,F=null;Page_index.parking={init:o}}(jQuery,"#indexParkPanel"),function(a,b){function c(a){B&&B.abort(),B=Common.ajax({url:A.url_getFloors,type:"get",data:a,success:function(b){b.success&&e(a,b.details),void 0!=a.floorIndex&&s.find("[data-floor="+a.floorIndex+"] .floor-header").trigger("click")},error:function(){},complete:function(){}})}function d(b,c){C&&C.abort();var d=a(c,s);d.addClass("floor-loading"),C=Common.ajax({url:A.url_getRooms,type:"get",data:b,success:function(a){if(a.success){var e=a.details,g=0==e.pagination.totalPage||e.pagination.curPage==e.pagination.totalPage;f(e,c,g),d.attr("data-curpage",b.curPage)}},error:function(){},complete:function(){d.removeClass("floor-loading")}})}function e(a,b){var c=w({moreid:a.buildingId+"_"+a.unitId,floors:b});s.html(c)}function f(b,c,d){for(var e=0;e<b.list.length;e++){var f=b.list[e];encodeURI(f.statusText)}var g=y(b),h=a(c);h.before(g),d&&h.hide()}function g(){r.addClass("on").siblings().removeClass("on")}function h(){r=a(b),s=a(A.buildingListId),t=a("#floorBreadcrumb"),u=a("#subroomList"),v=a("#buildingPanel"),w=template.compile(a(A.floorTempId).html()),y=template.compile(a(A.roomTempId).html()),x=template.compile(a(A.subroomTempId).html())}function i(){s.on("click",".floor-header",function(){var b=a(this),c=b.parent(),e=c.attr("data-floor"),f=c.find(".floor-more"),g="#"+f.attr("id");z=[],s.find(".floor-room").removeClass("active"),c.toggleClass("on"),c.hasClass("on")&&(c.siblings().removeClass("on"),c.get(0).scrollIntoView()),f.attr("data-curpage")||d({projectId:n,buildingId:o,unitId:p,floor:e,curPage:1},g)}),s.on("click",".floor-more",function(){var b=a(this),c=b.attr("data-curpage"),e=b.parent().parent(),f=e.attr("data-floor"),g="#"+b.attr("id");d({projectId:n,buildingId:o,unitId:p,floor:f,curPage:parseInt(c)+1},g)}),a("#buildingCover").on("click",function(){return v.removeClass("active"),!1});var b=a("#buildingPanel");a("#btn-sure").on("click",function(){z.length>1?a("#mergeModal").modal("show"):alert("合并房屋需要选择2个及以上房屋才能进行")}),a("#btnMerge").on("click",function(){var b=a("#parentHouseName").val(),c=a("#parentHousecheckinTime").val(),d={};if(!b||!c||""==a.trim(b))return alert("名称跟入住时间不能为空"),!1;a("#dtn-sure").parent().hide(),window.editstate=!1;var e=s.find(".on"),f=(e.attr("data-floor"),e.find(".floor-more"));"#"+f.attr("id");s.find(".active").removeClass("active"),d.houseName=b,d.houseIds=z,d.checkinTime=c,j(d),a("#parentHouseName,#parentHousecheckinTime").val(""),a("#mergeModal").modal("hide")}),a("#btn-cancel").on("click",function(){a(this).parent().hide();var c=s.find(".floor-room");c.removeClass("active"),window.editstate=!1,z=[],b.css("top","42px")}),a("#house-combine").on("click",function(){window.editstate=!0,a("#house-combine-btn").show(),b.css("top","80px"),z=[]});var c={};c.In=function(a,b){for(var c="-1",d=0;d<b.length;d++)try{return b[d]==a&&(c=d),c}catch(e){}},c.compare=function(a,b){for(var c=0;c<b.length;c++)try{if(b[c]==a)return!0}catch(d){}},c.remove=function(a,b){for(var c in b)try{b[c]==a&&(b=b.splice(c,1))}catch(d){}},s.add(u).on("click",".floor-room-wrap>.floor-room",function(b){var d=a(this),e=d.attr("data-id");e&&0==window.editstate&&k(e),e&&1==window.editstate&&(d.hasClass("active")?(d.removeClass("active"),c.compare(e,z)&&c.remove(e,z)):(d.addClass("active"),z.push(e))),b.stopPropagation()}),s.on("click",".floor-room-split .along-house-Info,.floor-room-split .merge-house-info,.floor-room-split .floor-room-okhouse,.floor-room-merge .merge-house-info,.floor-room-merge .floor-room-okhouse,.hlist li,.floor-room .floor-room",function(b){var c=a(this),d=c.attr("data-id");if(d&&0==window.editstate){var d=c.attr("data-id");k(d)}})}function j(b){D&&D.abort();var c=A.url_mergeRooms.replace("{:houseIds}",b.houseIds.join(","));D=Common.ajax({url:c,type:"post",data:b,success:function(b){if(b.success){var c=s.find(".on"),e=c.attr("data-floor"),f=c.find(".floor-more"),g="#"+f.attr("id");a(g).addClass("park-loading").show().prevAll().remove(),d({projectId:n,buildingId:o,unitId:p,floor:e},g),alert("合并成功")}},error:function(){},complete:function(){}})}function k(a){if(a){var b=path.server+"/page/house/"+a+"/details";window.location.href=b}}function l(a,b){o=a.buildingId,p=a.unitId,n=a.projectId,s.empty(),t.html(breadTemp(b)),c({projectId:n,buildingId:o,unitId:p,floorIndex:a.floorIndex})}function m(a,b){q||(q=!0,h(),i()),l(a,b),g()}var n,o,p,q=!1,r=null,s=null,t=null,u=null,v=null,w=null,x=null,y=null,z=[],A={url_getFloors:servicePath.house+"/v1/house/floor",url_getSubroom:servicePath.house+"/v1/house/subhouse",url_getRooms:servicePath.house+"/v1/house/floor/overviews",url_mergeRooms:servicePath.house+"/v1/house/{:houseIds}/merge",url_mergeSubRooms:servicePath.house+"/v1/subHouse/{:subHouseIds}/merge",url_splitRoom:servicePath.house+"/v1/house/{:houseId}/split",url_splitSubRoom:servicePath.house+"/v1/subHouse/{:subHouseId}/split",url_delSubRoom:servicePath.house+"/v1/house/{:subHouseId}/del",floorTempId:"#indexFloorTemp",roomTempId:"#indexRoomTemp",subroomTempId:"#subroomTemp",buildingListId:"#buildingList",status:{"%E5%B8%B8%E4%BD%8F":"state01","%E7%A9%BA%E7%BD%AE":"state02","%E5%BA%A6%E5%81%87":"state03","%E5%87%BA%E7%A7%9F":"state04","%E8%BD%A6%E4%BD%8D":"state05"}},B=null,C=null,D=null;Page_index.floor={init:m,getRooms:d}}(jQuery,"#indexFloorPanel"),function(){var a=Common.hash.get(),b=a.treeids||"",c=b.split(","),d=c&&c.length;Page_index.tree.init(b),b&&("5"==a.leveltype||"6"==a.leveltype?Page_index.floor.init({unitId:c[d-1],buildingId:c[d-2],projectId:c[d-3]}):"9"==a.leveltype&&Page_index.parking.init({projectId:c[d-2],carparkId:c[d-1]})),$("#btnExportRoom").on("click",function(){ExportRoom()})}();