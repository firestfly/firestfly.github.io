<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<comment>短信相关sql</comment>
	
	<entry key="callcenter.sms.tree">
	<![CDATA[
		-- 获取短信模板分类第一层
		SELECT c.id,
		       IFNULL(c.type_name, '呼叫中心') AS TEXT,
		       IFNULL(c.parent_Id, 'root') AS PARENT_ID,
		       c.enabled as status,
		       (CASE
				 WHEN c.enabled = 1 THEN 'black'
				 WHEN c.enabled = 0 THEN 'grey'
			   END) as font_color,
		       CASE (SELECT COUNT(*) FROM sms_template_categories WHERE PARENT_ID = c.ID)
		         WHEN 0 THEN '0' ELSE '1' END AS LEAF
		  FROM sms_template_categories c
		 WHERE c.deleted = 0
		 {?and c.enabled = #enabled#}
		 ORDER BY c.type_name
	]]>
	</entry>
	<entry key="callcenter.sms.template.list">
	<![CDATA[
		-- 短信模板列表
		SELECT c.type_name as category_name,
		       (CASE
				 WHEN st.type = 1 THEN '固定模板'
				 WHEN st.type = 2 THEN '半定义模板'
			   END) as type_name,
		       (CASE
				 WHEN now() < st.start_date THEN ''
				 WHEN now() > DATE_ADD(st.end_date,Interval 1 day) THEN ''
				 WHEN st.enabled = 1 THEN CONCAT(CONCAT('<a href="javascript:void(0);" onclick="enableTemplage(\'',st.id),'\',\'0\');">已启用</a>')
				 WHEN st.enabled = 0 THEN CONCAT(CONCAT('<a href="javascript:void(0);" onclick="enableTemplage(\'',st.id),'\',\'1\');">已禁用</a>')
			   END) as enabled_name,
		       (CASE
				 WHEN now() < st.start_date THEN '待生效'
				 WHEN now() < DATE_ADD(st.end_date,Interval 1 day) THEN '已生效'
				 WHEN now() > DATE_ADD(st.end_date,Interval 1 day) THEN '已失效'
			   END) as status,
		       st.*
		  FROM sms_template st,sms_template_categories c  
		 WHERE st.category_id = c.id 
		   and st.deleted = 0
		{? AND st.name LIKE CONCAT(CONCAT('%',#name#),'%') ESCAPE '/' }
		{? AND st.category_id in (SELECT st.id FROM sms_template_categories st WHERE st.id = #categoryId# or st.parent_id = #categoryId#) }
		{? AND st.enabled = #enabled# }
		{? AND st.content LIKE CONCAT(CONCAT('%',#content#),'%') ESCAPE '/' }
		{? and (CASE
				 WHEN now() < st.start_date THEN 1
				 WHEN now() < DATE_ADD(st.end_date,Interval 1 day) THEN 2
				 WHEN now() > DATE_ADD(st.end_date,Interval 1 day) THEN 3
			   END) = #status# }
	]]>
	</entry>
	
	
	<!-- 校验模板是否存在 -->
	<entry key="callcenter.sms.template.isTemplateExist">
	<![CDATA[
			SELECT count(1)
			  from sms_template t
			 where t.deleted = 0
			   and t.name = #name#
			   and t.category_id = #categoryId#
			 {?and t.ID != #id#}

	]]>
	</entry>	
	<!-- 校验模板是否存在 -->
	<entry key="callcenter.sms.template.isCategoryExist">
	<![CDATA[
			SELECT count(1)
			  from sms_template_categories t
			 where t.deleted = 0
			   and t.type_name = #typeName#
			   and t.parent_id = #parentId#
			 {?and t.ID != #id#}

	]]>
	</entry>
	
	
	<entry key="callcenter.sms.templateCategories.disabled.categories">
	<![CDATA[
		-- 禁用分类及下级分类
		UPDATE sms_template_categories t
		   SET t.enabled = 0
		 WHERE t.enabled != 0
		   and (t.id = ? OR t.parent_id = ?)
	]]>
	</entry>
	
	<entry key="callcenter.sms.templateCategories.disabled.template">
	<![CDATA[
		-- 禁用分类及下降分类 的模板
		UPDATE sms_template t
		   SET t.enabled = 0
		 WHERE t.enabled != 0
		   and t.category_id IN (SELECT stc.id
		                           FROM sms_template_categories stc
		                          WHERE stc.id = ?
		                             OR stc.parent_id = ?)
	]]>
	</entry>
	
	<entry key="callcenter.sms.templateCategories.isCategoryDisabled">
	<![CDATA[
		-- 查看分类是否被禁用，如果分类被禁用，不能启用
		SELECT count(*)
		  FROM sms_template t, sms_template_categories c
		 WHERE t.category_id = c.id
		   AND c.enabled = 0
		   AND t.id = ?
	]]>
	</entry>
	
	<entry key="callcenter.sms.templateCategories.isParentDisabled">
	<![CDATA[
		-- 查看上级分类是否被禁用，如果分类被禁用，不能启用
		SELECT count(*)
		  FROM sms_template_categories t, sms_template_categories c
		 WHERE t.parent_id = c.id
		   AND c.enabled = 0
		   AND t.id = ?
	]]>
	</entry>
	
	<entry key="callcenter.sms.templateCategories.delete.categories">
	<![CDATA[
		-- 删除分类及下级分类
		UPDATE sms_template_categories t
		   SET t.deleted = 1, t.duid = ?, t.dtime = now()
		 WHERE t.deleted != 1
		   and (t.id = ? OR t.parent_id = ?)
	]]>
	</entry>
	
	<entry key="callcenter.sms.templateCategories.delete.template">
	<![CDATA[
		-- 删除分类及下降分类 的模板
		UPDATE sms_template t
		   SET t.deleted = 1, t.duid = ?, t.dtime = now()
		 WHERE t.deleted != 1
		   and t.category_id IN (SELECT stc.id
		                           FROM sms_template_categories stc
		                          WHERE stc.id = ?
		                             OR stc.parent_id = ?)
	]]>
	</entry>
	
	
	<entry key="callcenter.sms.log.list">
	<![CDATA[
		-- 短信日志列表
		SELECT (SELECT group_concat(m.mobile)
		          FROM sms_send_mobile m
		         WHERE m.send_id = l.id) AS numbers,
		       (CASE
				 WHEN l.type = 1 THEN '固定模板'
				 WHEN l.type = 2 THEN '半定义模板'
				 WHEN l.type = 3 THEN '自定义模板'
			   END) as type_text,
		       (CASE
				 WHEN l.success = 1 THEN '成功'
				 WHEN l.success = 0 THEN '失败'
			   END) as success_text,
		       (CASE
				 WHEN l.return_code = 'DELIVRD' THEN '状态成功'
				 WHEN l.return_code = 'UNDELIV' THEN '状态失败'
				 WHEN l.return_code = 'EXPIRED' THEN '因为用户长时间关机或者不在服务区等导致的短消息超时没有递交到用户手机上'
				 WHEN l.return_code = 'REJECTD' THEN '消息因为某些原因被拒绝'
				 WHEN l.return_code = 'MBBLACK' THEN '黑号'
			   END) as return_name,
		       l.*
		  FROM sms_send_log l
		 WHERE 1 = 1
		 {?and exists (SELECT 1 FROM sms_send_mobile m1 WHERE m1.mobile = #mobile# and m1.send_id = l.id)}
		 {?and l.send_time > date_format(#timeBegin#, '%Y-%m-%d')}
		 {?and l.send_time < DATE_ADD(date_format(#timeEnd#, '%Y-%m-%d'), Interval 1 day)}
		 {?and l.type = #type#}
		 {?and l.send_name like CONCAT(CONCAT('%', #createdBy#), '%') ESCAPE '/'}
		 {?and l.content like CONCAT(CONCAT('%', #content#), '%') ESCAPE '/'}
		 {?and l.success = #success#}
		 order by l.send_time desc
	]]>
	</entry>
	
</properties>