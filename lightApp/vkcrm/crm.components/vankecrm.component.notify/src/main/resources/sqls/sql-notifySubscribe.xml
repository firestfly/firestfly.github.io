<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
    <comment>订阅关系SQL</comment>

    <!--查询所有订阅关系-->
    <entry key="sql.notifySubscribe.all">
        <![CDATA[
        SELECT * FROM biz_notify_subscribe WHERE 1 = 1
        {? AND (updated_at > #lastUpdatedTime# }
        {? OR deleted_at > #lastUpdatedTime#) }
        ]]>
    </entry>

    <!--查询订阅关系的所有规则-->
    <entry key="sql.notifySubscribe.rules.query">
        <![CDATA[
        SELECT * FROM biz_notify_subscribe_rules WHERE subscribe_id = #subscribeId# AND basis = #basis#
        ]]>
    </entry>

    <!--添加通知-->
    <entry key="sql.notify.add">
        <![CDATA[
        INSERT INTO `biz_notify`
        (`id`,
        `type`,
        `content`,
        `created_by`,
        `created_at`)
        VALUES
        (#id#,
         #type#,
         #content#,
         #created_by#,
         #created_at#);
        ]]>
    </entry>

    <!--添加通知到用户-->
    <entry key="sql.notify.add.user">
        <![CDATA[
        INSERT INTO `biz_notify_user`
        (`user_id`,
        `notify_id`,
        `received`,
        `received_at`,
        `read`,
        `deleted`)
        VALUES
        (?,
        ?,
        1,
        NOW(),
        0,
        0);
        ]]>
    </entry>

    <!--查询未读通知数量-->
    <entry key="sql.notify.query.count">
        <![CDATA[
        SELECT COUNT(1) FROM biz_notify_user u
        INNER JOIN biz_notify n ON u.notify_id = n.id
        WHERE user_id = #subscriberId# AND u.received = 1 AND u.read = 0 AND u.deleted = 0
        ]]>
    </entry>

    <!--查询通知-->
    <entry key="sql.notify.query">
        <![CDATA[
        SELECT n.*, u.received, u.received_at, u.read, u.read_at, u.deleted, u.deleted_at FROM biz_notify_user u
        INNER JOIN biz_notify n ON u.notify_id = n.id
        WHERE user_id = #subscriberId# AND u.deleted = 0
        {? AND n.type = #type# }
        {? AND u.received = #received# }
        {? AND u.read = #read# }
        {? AND u.received_at >= #startTime# }
        {? AND u.received_at <= #endTime# }
        {? AND n.content like CONCAT(CONCAT('%',#content#),'%') ESCAPE '/' }
        ]]>
    </entry>

    <!--查询指定id的通知-->
    <entry key="sql.notify.query.ids">
        <![CDATA[
        SELECT * FROM biz_notify WHERE id IN ($notifyIds$) AND type = #type#
        ]]>
    </entry>

    <entry key="sql.notify.marked.read">
        <![CDATA[
        UPDATE biz_notify_user SET `read` = 1, read_at = NOW()
        WHERE user_id = #subscriberId# AND notify_id IN ($notifyIds$)
        ]]>
    </entry>

    <entry key="sql.notify.marked.read.condition">
        <![CDATA[
        UPDATE biz_notify_user SET `read` = 1, read_at = NOW()
        WHERE user_id = #subscriberId#
        {? AND received_at >= #startTime# }
        {? AND received_at <= #endTime# }
        {? AND notify_id IN (SELECT id FROM biz_notify WHERE type = #type#) }
        {? AND notify_id IN (SELECT id FROM biz_notify WHERE content like CONCAT(CONCAT('%',#content#),'%') ESCAPE '/') }
        ]]>
    </entry>

    <entry key="sql.notify.marked.deleted">
        <![CDATA[
        UPDATE biz_notify_user SET `read` = 1, read_at = NOW(), `deleted` = 1, deleted_at = NOW()
        WHERE user_id = #subscriberId# AND notify_id IN ($notifyIds$)
        ]]>
    </entry>

    <entry key="sql.notify.marked.deleted.condition">
        <![CDATA[
        UPDATE biz_notify_user SET `read` = 1, read_at = NOW(), `deleted` = 1, deleted_at = NOW()
        WHERE user_id = #subscriberId#
        {? AND received_at >= #startTime# }
        {? AND received_at <= #endTime# }
        {? AND notify_id IN (SELECT id FROM biz_notify WHERE type = #type#) }
        {? AND notify_id IN (SELECT id FROM biz_notify WHERE content like CONCAT(CONCAT('%',#content#),'%') ESCAPE '/') }
        ]]>
    </entry>

</properties>
